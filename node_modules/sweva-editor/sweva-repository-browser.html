<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="sweva-repository-browser">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-dialog.main {
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                margin: 20px;
                position: fixed;
                
            }

            .main .dialog-container {
                display: flex;
                flex-direction: column;
                height: 100%;
                width: 100%;
                box-sizing: border-box;
                padding-bottom: 25px;
            }

            .main .content {
                flex: 1 1 0;
                position: relative;
                margin-top: 15px;
                overflow: auto;
            }
            .item {
                display: flex;
               
                min-height: 110px;
                max-height: 300px;
                overflow: auto;
                margin-bottom: 5px;
                margin-left: 5px;
                margin-right: 5px;
                box-shadow: 0 1px 5px #777;
            }

            .item:hover {
                background-color:#dfeff9; 
            }
            .item .img-container {
                padding: 5px;
                height: 100px;
                width: 100px;
            }
            .item .img {
                width: 100px;
                height: 100px;
            }

            .item .description{
                flex: 1;
                width: 100%;
                padding: 5px;
            }

            .item .title {
                font-family: 'Roboto', 'Noto', sans-serif;
                font-size: 16px;
                font-weight: 400;
                line-height: 24px;
            }

            .item .text {
                font-family: 'Roboto', 'Noto', sans-serif;
                font-size: 12px;
                font-weight: 400;
                letter-spacing: 0.011em;
                line-height: 20px;
            }

            /* After Polymer 2.0 Update, this style fixes the Material Design Look of paper-button*/
            .buttons paper-button  {
                background-color: var(--paper-indigo-500);
                color: white;
                --paper-button-raised-keyboard-focus: {
                    background-color: var(--paper-pink-a200) !important;
                    color: white !important;
                };
            }

            .buttons paper-button:hover {
                background-color: var(--paper-indigo-100);
            }
        </style>
        <iron-ajax id="ajax"
                   url=""
                   handle-as="json"
                   on-response="handleResponse"
                   debounce-duration="100"></iron-ajax>
        <paper-dialog class="main">
            <div class="dialog-container">
                <h2>{{label}}</h2>
                <div class="content">
                    <template is="dom-repeat" items="{{items}}">
                        <div class="item" data-url$="{{item.url}}" on-click="handleItemSelected">
                            <div class="img-container">
                                <img src="{{item.thumbnail}}"/>
                            </div>
                            <div class="description">
                                <div class="title">
                                    {{item.title}}
                                </div>
                                <div class="text">
                                    {{item.description}}
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="buttons" style="margin-left: auto">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button on-click="handleAccept">Accept</paper-button>
                </div>
            </div>
        </paper-dialog>
    </template>
    <script>
        class SwevaRepositoryBrowser extends Polymer.Element {
          static get is() {
            return 'sweva-repository-browser';
          }

          static get properties() {
            return {
                /* properties meta data object just like 1.x */
              label: {
                type: String,
                value: 'Browse'
              },
              repositoryUrl: {
                type: String,
                value: ''
              },
              category: {
                type: String,
                value: ''
              },
              callback: {
                type: Object,
                value: null
              },
              selectedUrl: {
                type: String,
                value: ''
              },
              items: {
                type: Array,
                value: []
              }
            }
          }

          ready() {
            super.ready();
          }

          // ConnectedCallback replaces the attached function in Polymer 2.0
          connectedCallback(){
            super.connectedCallback();
            Polymer.RenderStatus.afterNextRender(this, function() {
              var dialog = this.shadowRoot.querySelector('paper-dialog.main');
              var self = this;
              if (dialog) {
                dialog.addEventListener('iron-overlay-closed', function (customEvent) {
                  self.isOpen = false;
                });
              }
            });
          }

          open(options) {
            var dialog = this.shadowRoot.querySelector('paper-dialog.main');
            if (dialog) {
              this.callback = options.callback;
              this.category = options.category;
              this.$.ajax.url = this.repositoryUrl + this.category + '.json';
              this.$.ajax.generateRequest();
              this.isOpen = true;
              dialog.open();
            }
          }

          handleAccept() {
            var dialog = this.shadowRoot.querySelector('paper-dialog.main');
            if (dialog) {
              this.isOpen = false;
              if (typeof this.callback === 'function') {
                this.callback(this.selectedUrl);
              }
              dialog.close();
            }
          }

          handleResponse(request) {
            this.items = request.detail.response.data;
          }

          handleItemSelected(event) {
            var current = event.target;
            while (!current.dataset.url && current.parentNode) {
              current = current.parentNode;
            }
            this.selectedUrl = current.dataset.url;
            this.handleAccept();
          }
        }

        // Register custom element definition using standard platform API
        customElements.define(SwevaRepositoryBrowser.is, SwevaRepositoryBrowser);
    </script>
</dom-module>