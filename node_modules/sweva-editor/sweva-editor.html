<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">

<link rel="import" href="sweva-canvas.html">
<link rel="import" href="sweva-panel.html">
<link rel="import" href="sweva-code.html">
<link rel="import" href="sweva-cursor-awareness.html">
<link rel="import" href="sweva-user-manager.html">
<link rel="import" href="sweva-chat.html">
<link rel="import" href="sweva-node-manager.html">


<!--
An element providing a solution to no problem in particular.

Example:

  <seed-element></seed-element>

Example:

  <seed-element>
    <h2>Hello seed-element</h2>
  </seed-element>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="sweva-editor">
  <template>
     
    <style>
      :host {
        font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        display: flex;
        height: 100%;
        position: relative;
        -webkit-user-select: none; /* Chrome/Safari */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* IE10+ */
        /* Rules below not implemented in browsers yet */
        -o-user-select: none;
        user-select: none;
        padding: 5px;
        height: 100%;
        box-sizing: border-box;
         
        overflow: hidden;
        --dark-primary-color: #1976D2;
        --default-primary-color: #2196F3;
        --light-primary-color: #FFF;
        --text-primary-color: #FFFFFF;
        --accent-color: #FF5722;
        --primary-background-color: #FFF;
        --primary-text-color: #212121;
        --secondary-text-color: #727272;
        --disabled-text-color: #BDBDBD;
        --divider-color: #B6B6B6;
      }

      sweva-canvas {
        flex: 1 1 auto;
      }

      sweva-panel {
        flex: 0 0 auto;
      }

      .dialog-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        box-sizing: border-box;
        padding-bottom: 25px;
      }

      paper-dialog {
        background: #fff;
        width: 100%;
      }

      /* After Polymer 2.0 Update, this style fixes the Material Design Look of paper-button*/
      .buttons paper-button  {
        background-color: var(--paper-indigo-500);
        color: white;
        --paper-button-raised-keyboard-focus: {
          background-color: var(--paper-pink-a200) !important;
          color: white !important;
        };
      }

      .buttons paper-button:hover {
        background-color: var(--paper-indigo-100);
      }

      paper-spinner {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 50px;
        height: 50px;
        display:block;
        z-index: 9001;
      }


      /* JS Plumb Style Sheets */

      .jsplumb-endpoint {
        cursor: pointer;
      }

      .jsplumb-connector {
        z-index: 4;
      }

      .jsplumb-endpoint, .endpointTargetLabel, .endpointSourceLabel {
        z-index: 21;
        cursor: pointer;
      }

      .node-label {
        z-index: 20;
        padding: 0 5px;
        max-width: 200px;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        user-select: none;
        background-color: rgba(255,255,255,0.5);
        pointer-events: none;
      }

      .node-data-out-endpoint-label {
        transform: translateX(0) !important;
        border: 2px solid #ff9d00;
      }

      .node-input-endpoint-label {
        transform: translateX(0%)rotate(-90deg) !important;
        border: 2px solid #333;
        transform-origin: 0% 100%;
        padding-left: 15px;
      }

      .node-data-in-endpoint-label {
        transform: translateX(-100%) !important;
        border: 2px solid #0094ff;
      }

      .basicContextContainer {
        font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      }
    </style>

    <paper-spinner id = "spinner" active="{{!loaded}}"></paper-spinner>

    <sweva-canvas id="canvas-container"
                  canvas-offset-x="{{canvasOffset.x}}"
                  canvas-offset-y="{{canvasOffset.y}}"
                  on-canvasmousemove="handleCanvasMouseMove"
                  on-viewportchanged="handleViewPortChanced">

      <sweva-cursor-awareness id="cursor-awareness"></sweva-cursor-awareness>
      <sweva-node-manager id="node-manager"
                          canvas-offset="{{canvasOffset}}"
                          repository-url-prefix="{{repositoryUrlPrefix}}"
                          repository-url-suffix="{{repositoryUrlSuffix}}"
                          on-jsplumbloaded="handleJsPlumbLoaded"
                          on-nodecreated="handleNodeCreated"
                          on-nodeselected="handleNodeSelection"
                          on-editnode="handleEditNode"
                          on-clonenode="handleCloneNode"
                          on-deletenode="handleDeleteNode"
                          on-repositorybrowse="handleRepositoryBrowse"
                          on-updatevisualization = "handleUpdateVisualization"
                          on-edit-node="_handleEditNode"
                          canvas="{{canvas}}">
      </sweva-node-manager>
    </sweva-canvas>

    <sweva-chat></sweva-chat>

    <sweva-panel on-createnode="handleCreateNode"
                 on-autolayout="handleAutoLayout"
                 on-userdatachanged="handleUserDataChanged"
                 on-deletenode="handleDeleteNode"
                 on-clearall="handleClearAll"
                 on-imported="handleImported"
                 on-editnode="handleEditNode"
                 on-clonenode="handleCloneNode"
                 on-editproject="handleEditProject"
                 on-execute="handleExecute"
                 on-downloadproject="handleDownloadProject"
                 on-switchroom="handleSwitchRoom"
                 on-updatemodel="handleUpdateModel"
                 on-repositorybrowse="handleRepositoryBrowse"
                 on-collapsed="handleCollapsed"
                 on-createinputnode="handleCreateInputNode"
                 on-openvisualizationselect="handleOpenVisualizationSelect">
    </sweva-panel>

    <sweva-user-manager on-useradded="handleUserAdded"
                        on-userdeleted="handleUserDeleted"
                        on-userupdated="handleUserUpdated">
    </sweva-user-manager>

    <sweva-code id="editor-dialog"
                on-edited="handleEditComplete">
    </sweva-code>

    <div id="editors">
    </div>

    <paper-dialog id="visualization-select">
      <div class="dialog-container">
        <h2>Select Visualization</h2>
        <div style="display:flex;align-items: center;">
          <paper-input label="Visualization URL" style="flex:1" value="{{visualization}}">
          </paper-input>
          <paper-icon-button title="Browse Visualizations"icon="icons:timeline" on-click="handleOpenVisualizationRepository"></paper-icon-button>
        </div>
        <div class="buttons" style="margin-left: auto">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm on-click="handleAcceptVisualization">Accept</paper-button>
        </div>
      </div>
    </paper-dialog>
     
    <sweva-repository-browser id="repository-browser" repository-url="{{repositoryUrlPrefix}}"></sweva-repository-browser>
  </template>

  <script src="../yjs/y.js"></script>
  <script>
    if (!window.module) {
      window.module = {};
    }
  </script>

  <script src="../y-memory/y-memory.js"></script>
  <script src="../y-map/y-map.js"></script>
  <script src="../y-array/y-array.js"></script>
  
  <script src="../y-text/y-text.js"></script>

  <script src="../y-websockets-client/y-websockets-client.js"></script>

  <script src="../gsap/src/minified/TweenLite.min.js"></script>
  <script src="../gsap/src/minified/plugins/CSSPlugin.min.js"></script>
  <script src="../jsplumb/dist/js/jsPlumb-2.1.0.js"></script>
  <script src="../axios/dist/axios.min.js"></script>
  <!--<script src="https://cdn.rawgit.com/cpettitt/dagre/master/dist/dagre.js"></script>-->
  <script src="../lodash/dist/lodash.js"></script>
  <script src="../graphlib/dist/graphlib.core.js"></script>
  <script src="../dagre/dist/dagre.core.js"></script>

  <script src="../../node_modules/sweva-core/dist/core.build.js"></script>
  <!--<script src="../../node_modules/sweva-core/dist/core.build.min.js"></script>-->
  <script src="../download-as-file/dist/download-as-file.js"></script>
  <!--<script src="../dagre/dist/dagre.core.min.js"></script>-->
  <!--<script src="../graphlib/dist/graphlib.core.min.js"></script>-->
  <script>

    class SwevaEditor extends Polymer.Element {
      static get is() {
        return 'sweva-editor';
      }

      static get properties() {
        return {
          /* properties meta data object just like 1.x */
          jsPlumbInstance: {
            type: Object,
            value: null
          },
          yjs: {
            type: Object,
            value: null
          },
          repositoryUrlPrefix: {
            type: String,
            value: '/bower_components/sweva-module-repos/'
          },
          repositoryUrlSuffix: {
            type: String,
            value: '.json'
          },
          yjsServer: {
            type: String,
            value: 'https://yjs.dbis.rwth-aachen.de:5072'
          },
          project: {
            type: Object,
            value: {
              code: '',
              input: '',
              data: ''
            }
          },
          executionManager: {
            type: Object,
            value: null
          },
          canvasOffset: {
            type: Object,
            value: {
              x: -2000,
              y: -2000
            }
          },
          room: {
            type: String,
            value: '',
            observer: '_roomChanged'
          },
          visualization: {
            type: String,
            value: ''
          },
          loaded: {
            type: Boolean,
            value: false
          },
          canvas: {
            type: Object
          }
        }
      }

      ready() {
        super.ready();

        this.canvas = this.$['canvas-container'];
      }

      connectedCallback() {
        super.connectedCallback();
        Polymer.RenderStatus.beforeNextRender(this, function () {
          this.shadowRoot.querySelector('#visualization-select').fitInto = this;
        });
      }

      _roomChanged() {
        this.start(this.room)
      }

      handleUpdateVisualization(event) {
        this.updateVisualization(event.detail);
      }

      handleOpenVisualizationRepository() {
        var repo = this.shadowRoot.querySelector('#repository-browser');
        var self = this;
        repo.open({
          category: 'visualizations',
          callback: function (url) {
            self.updateVisualization(url);
          }
        });
      }

      updateVisualization(url) {
        this.visualization = url;
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        nodeManager.updateVisualization(this.visualization);
        this.yjs.share.project.set('visualization', this.visualization);
      }

      handleAcceptVisualization() {
        this.updateVisualization(this.visualization);
      }

      handleOpenVisualizationSelect() {
        var visualization = this.shadowRoot.querySelector('#visualization-select');
        if (visualization) {
          visualization.open();
        }
      }

      handleRepositoryBrowse(event) {
        var repo = this.shadowRoot.querySelector('#repository-browser');
        repo.open(event.detail);
      }

      handleCollapsed(event) {
        var chat = this.shadowRoot.querySelector('sweva-chat');
        chat.collapsed = (event.detail);
      }

      handleNodeCreated(event) {
        var node = event.detail;
        if (!this.shadowRoot.getElementById(node.id + 'editor')) {
          var editor = document.createElement('sweva-node-editor');
          editor.id = node.id + 'editor';
          Polymer.dom(this.$.editors).appendChild(editor);
          Polymer.dom.flush();
          editor.init(this.yjs, node);
        }
      }

      handleNodeSelection(event) {
        self.loaded = true;
        var panel = this.shadowRoot.querySelector('sweva-panel');
        panel.updateNode(event.detail);
        var userManager = this.shadowRoot.querySelector('sweva-user-manager');
        userManager.updateSelectedNode(event.detail);
      }


      handleCanvasMouseMove(event) {
        var position = event.detail;
        var userManager = this.shadowRoot.querySelector('sweva-user-manager');
        userManager.updateCursor(position.x, position.y);
      }

      handleViewPortChanced(event) {
        var cursors = this.shadowRoot.querySelector('#cursor-awareness');
        cursors.updateViewport(event.detail);
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        nodeManager.updateViewport(event.detail);
      }

      handleUserAdded(event) {
        if (!event.detail.isSelf) {
          var cursors = this.shadowRoot.querySelector('#cursor-awareness');
          cursors.add(event.detail);
        }
      }

      handleUserDeleted(event) {
        if (!event.detail.isSelf) {
          var cursors = this.shadowRoot.querySelector('#cursor-awareness');
          cursors.remove(event.detail);
          var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
          nodeManager.selectNodeBy('', '', '#fff');
        }
      }

      handleUserUpdated(event) {
        var cursors = this.shadowRoot.querySelector('#cursor-awareness');
        cursors.update(event.detail.id, event.detail);
        if (!event.detail.isSelf && event.detail.selectedNode) {
          var userManager = this.shadowRoot.querySelector('sweva-user-manager');
          var color = userManager.getUserColor(event.detail.id);
          var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
          nodeManager.selectNodeBy(event.detail.selectedNode, event.detail.id, color);
        }
        if (event.detail.isSelf && (event.detail.name || event.detail.color)) {
          var panel = this.shadowRoot.querySelector('sweva-panel');
          panel.updateUser(event.detail);
          var chat = this.shadowRoot.querySelector('sweva-chat');
          chat.updateUser(event.detail);
        }
      }

      handleUserDataChanged(event) {
        var userManager = this.shadowRoot.querySelector('sweva-user-manager');
        userManager.update(userManager.ownId, event.detail);
      }

      handleClearAll(event) {
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        nodeManager.clear();
        var children = Polymer.dom(this.$.editors).children;
        for (var i = 0; i < children.length; i++) {
          var child = children[i];
          Polymer.dom(this.$.editors).removeChild(child);
        }
        Polymer.dom.flush();
      }

      handleDownloadProject() {
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        var code = this.project.code;
        if (code.trim().length == 0) {
          code = sweva.ComposableLoader.getDefaultComposition();
        }
        var obj = nodeManager.getComposition(code);
        var data = JSON.stringify(obj, null, 4);
        downloadAsFile({
          data: data,
          filename: (obj.name || 'composition') + '.json'
        })
      }

      handleAutoLayout(event) {
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        nodeManager.autoLayout();
      }

      handleCreateInputNode() {
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        nodeManager.createInputNode();
      }

      handleCreateNode(event) {
        var nodeManager = this.$['node-manager'];
        nodeManager.createNode(event.detail);
      }

      handleDeleteNode(event) {
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        nodeManager.deleteNode(event.detail);
        var editor = this.shadowRoot.getElementById(event.detail.id+'editor');
        if (editor) {
          this.$.editors.removeChild(editor);
          //Polymer.dom.flush();
        }
      }

      handleEditProject() {
        var editor = this.shadowRoot.querySelector('#editor-dialog');
        if (editor) {
          var code = this.project.code;
          if (code.trim().length == 0) {
            code = sweva.ComposableLoader.getDefaultComposition();
          }
          editor.open('Edit Project', 'project.code', code);
        }
      }

      handleUpdateModel() {
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        var code = this.project.code;
        if (code.trim().length == 0) {
          code = sweva.ComposableLoader.getDefaultComposition();
        }
        var obj = nodeManager.getComposition(code);
        console.log(obj); // for testing purposes will remove after visualisation part is ready.
        this.dispatchEvent(new CustomEvent('modelupdated', { bubbles: true, composed: true , detail: obj }));
      }

      handleEditComplete(event) {
        var id = event.detail.id;
        var code = event.detail.code;
        if (code) {
          if (id == 'project.code') {
            this.yjs.share.project.set('code', code);
          }
          /* else if (id == 'project.input') {
           this.yjs.share.project.set('input', code);
           }
           else if (id == 'project.data') {
           this.yjs.share.project.set('data', code);
           }*/
          else {
            var node = this.shadowRoot.getElementById(id);
            if (node) {
              node.updateCode(code);
            }
          }
        }
      }

      _handleEditNode(e) {
        let nodeId = e.detail.id;
        let alias = e.detail.alias;
        this.shadowRoot.getElementById(nodeId + 'editor').open('Edit Node ' + alias);
        //document.getElementById(this.id+'editor').open('Edit Node ' + this.alias);
      }

      handleEditNode(event) {
        var node = event.detail;
        if (node) {
          node.edit();
          /* var editor = this.$$('#editor-dialog');
           if (editor) {
           editor.open('Edit Node ' + node.alias, node.id, node.code);
           }*/
        }
      }

      handleCloneNode(event) {
        var node = event.detail;
        if (node) {
          var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
          if (nodeManager) {
            nodeManager.cloneNode(node);
          }
        }
      }

      handleJsPlumbLoaded(event) {
        var canvas = this.$['canvas-container'];
        if (canvas) {
          canvas.jsPlumbInstance = event.detail;
        }
      }

      handleImported(event) {
        var mode = event.detail.mode;
        var content = event.detail.content;
        var alias = event.detail.alias;
        if (typeof content !== 'string' || content.trim().length < 1) {
          return;
        }
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        switch (mode) {
          case 'importNodeJson':
            nodeManager.importNodeJson(alias, content);
            break;
          case 'importNodeObject':
            nodeManager.importNodeObject(alias, content);
            break;
          case 'importCompositionJSON':
            nodeManager.importCompositionJSON(content);
            var obj = JSON.parse(content);
            if (obj.hasOwnProperty('composables')) {
              delete obj.composables;
            }
            if (obj.hasOwnProperty('links')) {
              delete obj.links;
            }
            if (obj.hasOwnProperty('controls')) {
              delete obj.controls;
            }
            if (obj.hasOwnProperty('visualization')) {
              delete obj.visualization;
            }
            var code = sweva.ComposableLoader.convertJsonToCode(obj);
            this.yjs.share.project.set('code', code);
            break;
          case 'importCompositionObject':
            nodeManager.importCompositionObject(content);
            break;
          default:
        }
      }

      handleSwitchRoom(event) {
        var room = event.detail;
        if (typeof room !== 'string'
          || room.trim().length == 0
          || room == this.room) {
          return;
        }
        this.cleanUp();
        this.room = room;
        //this.start(room);
      }

      cleanUp() {
        var cursorAwareness = this.shadowRoot.querySelector('sweva-cursor-awareness');
        cursorAwareness.cleanUp();
        var userManager = this.shadowRoot.querySelector('sweva-user-manager');
        userManager.cleanUp();
        var userChat = this.shadowRoot.querySelector('sweva-chat');
        userChat.cleanUp();
        var nodeManager = this.shadowRoot.querySelector('sweva-node-manager');
        nodeManager.cleanUp();
        this.yjs = null;
      }

      start(room) {
        if (typeof room !== 'string'
          || room.trim().length == 0) {
          return;
        }
        var self = this;
        /*this.executionManager = new sweva.ExecutionManager();
         this.executionManager.onProgress(function (progress) {
         var panel = self.querySelector('sweva-panel');
         panel.updateProgress(progress);
         });*/
        var panel = this.shadowRoot.querySelector('sweva-panel');
        //panel.updateRoom(room);
        Y({
          db: {
            name: 'memory'
          },
          connector: {
            name: 'websockets-client',
            room: room,
            // debug: true,
            url: self.yjsServer
          },
          share: {
            nodes: 'Map', // stores processing nodes
            edges: 'Map', // stores edges between processing and input nodes and in-between
            users: 'Map', // stores users
            chat: 'Array', // stores chat messages
            project: 'Map', // stores the whole project JSON if loaded manually
            mapper: 'Map',
            mapperContainers: 'Map', // stores input nodes
            mapperVisualization: 'Map'
          }
        }).then(function (y) {
          self.yjs = y;
          var yjs = y;

          // late join
          var code = yjs.share.project.get('code') || '';
          self.project.code = code;
          var visualization = yjs.share.project.get('visualization') || '';
          if (self.visualization !== visualization) {
            self.updateVisualization(visualization);
          }

          yjs.share.project.observe(function (event) {
            self.loaded = true;
            var code = yjs.share.project.get('code') || '';
            // var input = yjs.share.project.get('input') || {};
            // var data = yjs.share.project.get('data') || {};
            self.project.code = code;
            // self.project.input = input;
            //self.project.data = data;
          });

          //yjs.share.text.bind(document.querySelector("#editor-dialog #editor"))
          var userManager = self.shadowRoot.querySelector('sweva-user-manager');
          userManager.init(yjs);
          var userChat = self.shadowRoot.querySelector('sweva-chat');
          userChat.init(yjs);
          var nodeManager = self.shadowRoot.querySelector('sweva-node-manager');
          nodeManager.init(yjs);
          var editor = self.shadowRoot.querySelector('#editor-dialog');
          editor.init(yjs);
          var canvas = self.$['canvas-container'];
          canvas.pan(2, 2);
          console.log('editor loaded');
          self.loaded = true;
          /*setTimeout(function () {
            if (Object.keys(yjs.share.nodes.opContents).length == 0) {
              self.loaded = true;
            }
          }, 3000);*/
        });
      }
    }

    // Register custom element definition using standard platform API
    window.customElements.define(SwevaEditor.is, SwevaEditor);
  </script>
</dom-module>