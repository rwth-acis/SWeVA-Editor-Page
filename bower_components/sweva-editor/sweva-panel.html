<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/av-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="sweva-import-export-dialog.html">

<dom-module id="sweva-panel">
    <template>
        <style>
            :host {
                display: flex;
                width: 230px;
                background-color: white;
                box-shadow: 0 2px 8px #555;
                position: relative;
                flex-direction: column;
                transition: width cubic-bezier(0.18, 0.89, 0.32, 1.28) 0.2s;
            }
            iron-pages {
                flex: 1 1 0;
                overflow: auto;
                position: relative;
            }

            paper-button {
                background-color: #0094ff;
                color: #fff;
                margin: 5px;
                width: 100%;
            }

            .header {
                display: flex;
                align-items: center;
            }

            #demo-controls {
                border-top: 1px solid #999;
                padding: 5px;
            }

            #demo-controls paper-progress {
                width: 100%;
            }

            #demo-controls paper-button {
                margin: 0;
            }

            paper-tabs, paper-toolbar {
                background-color: #0094ff;
                color: #fff;
                /*--paper-tabs-selection-bar-color: #ff6a00;*/
            }

            paper-toolbar paper-tabs {
                box-shadow: none;
            }

            paper-tabs[noink][no-bar] paper-tab.iron-selected {
                color: #ff6a00;
            }

            .tab-page {
                padding: 5px;
                overflow: auto;
                position: absolute;
                right: 0;
                left: 0;
            }

            paper-card {
                width: 100%;
                margin-bottom: 18px;
                /*   --paper-card-header-text:
                {
                    padding: 8px;
                    text-align: center;
                }

                --paper-card-header: {
                    border-bottom: 1px solid #ccc;
                }*/
            }

            paper-card h2 {
                font-weight: 500;
                margin: 10px;
                text-align: center;
            }

            paper-card card-content {
                padding: 0 16px 16px 16px;
                position: relative;
            }

            paper-textarea {
                display: block;
                width: 100%;
                max-height: 500px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            paper-dialog {
                background: #fff;
            }

            paper-icon-button.pink {
                color: #db0064;
            }

            #room-selector {
                display: flex;
                padding: 0 10px;
            }

            #room-selector paper-icon-button {
                margin-top: 10px;
            }

            #room-name {
                flex: 1 1 0;
            }

            paper-icon-item {
                padding: 0 5px;
                height: 0;
                cursor: pointer;
                --paper-item-icon-width: 0px;
            }

            paper-icon-item .text {
                margin-left: 5px;
            }

            .hidden {
                display: none;
            }

            #demo-controls.hidden {
                padding: 0;
                display: block;
            }

            #demo-controls paper-icon-button {
                display: none;
            }

            #demo-controls paper-icon-button.hidden {
                display: block;
            }
        </style>
        <!--<div id="room-selector">
            <paper-input id="room-name" label="Room" value="{{room}}"></paper-input>
            <paper-icon-button title="Switch Room" icon="icons:launch" on-click="handleSwitchRoom"></paper-icon-button>
        </div>-->
        <div class="header">
            <paper-tabs selected="{{selectedTab}}" noink class$="{{_getCollapsedStyle(collapsed)}}">
                <paper-tab title="Create"><iron-icon icon="icons:note-add"></iron-icon></paper-tab>
                <paper-tab title="Edit"><iron-icon icon="icons:create"></iron-icon></paper-tab>
                <paper-tab title="Export"><iron-icon icon="icons:cloud-download"></iron-icon></paper-tab>
                <paper-tab title="Settings"><iron-icon icon="icons:settings"></iron-icon></paper-tab>
            </paper-tabs>
            <paper-icon-button title="Open and Close Sidebar" icon="icons:menu" on-click="handleCollapse"></paper-icon-button>
        </div>

        <sweva-import-export-dialog id="import-export-dialog"
                                    on-accepted="handleImportExportDialogAccepted">
        </sweva-import-export-dialog>

        <iron-pages selected="{{selectedTab}}" class$="{{_getCollapsedStyle(collapsed)}}">
            <div class="tab-page">

                <paper-card>
                    <h2>New Processing Node</h2>
                    <div class="card-content">
                        <paper-input id="create-node-name" label="Alias" value="{{createNodeAlias}}"></paper-input>
                        <paper-input id="create-node-url" label="Url" value="{{createNodeUrl}}"></paper-input>
                        <paper-icon-item on-click="handleOpenRepository">
                            <iron-icon item-icon icon="icons:extension"></iron-icon>
                            <div class="text">Browse Nodes</div>
                        </paper-icon-item>
                        <!--<paper-icon-item on-click="handleCreateNodeUrlFixed">
                            <iron-icon item-icon icon="icons:cloud-circle"></iron-icon>
                            <paper-item-body class="text" two-line>
                                <div>Create From Url</div>
                                <div secondary>(read-only)</div>
                            </paper-item-body>
                        </paper-icon-item>-->
                        <paper-icon-item on-click="handleCreateNodeUrl">
                            <iron-icon item-icon icon="icons:cloud-queue"></iron-icon>
                            <div class="text">Create From Url</div>
                        </paper-icon-item>
                        <paper-icon-item on-click="handleCreateNode">
                            <iron-icon item-icon icon="icons:cloud-off"></iron-icon>
                            <div class="text">Create Empty</div>
                        </paper-icon-item>

                        <paper-icon-item on-click="handleImportNodeJSON">
                            <iron-icon item-icon icon="icons:file-upload"></iron-icon>
                            <div class="text">Import as JSON</div>
                        </paper-icon-item>
                        <!--<paper-icon-item>
                            <iron-icon item-icon icon="icons:file-upload"></iron-icon>

                            <paper-dropdown-menu label="Import">
                                <paper-menu class="dropdown-content">
                                    <paper-item on-click="handleImportNodeJSON">JSON</paper-item>
                                    <paper-item on-click="handleImportNodeObject">Object</paper-item>
                                </paper-menu>
                            </paper-dropdown-menu>
                        </paper-icon-item>-->
                    </div>
                </paper-card>
                <paper-card>
                    <h2>New Input Node</h2>
                    <div class="card-content">

                        <paper-icon-item on-click="handleCreateInputNode">
                            <iron-icon item-icon icon="icons:accessibility"></iron-icon>
                            <div class="text">Create New</div>
                        </paper-icon-item>
                    </div>
                </paper-card>

                <paper-card>
                    <h2>Import Project</h2>
                    <div class="card-content">

                        <paper-icon-item on-click="handleImportCompositionJSON">
                            <iron-icon item-icon icon="icons:file-upload"></iron-icon>
                            <div class="text">Import as JSON</div>
                        </paper-icon-item>
                    </div>
                </paper-card>

                <paper-card>
                    <h2>Utilities</h2>
                    <div class="card-content">
                        <paper-icon-item on-click="handleAutoLayout">
                            <iron-icon item-icon icon="icons:apps"></iron-icon>
                            <div class="text">Auto Layout</div>
                        </paper-icon-item>
                        <paper-icon-item on-click="handleClearAll">
                            <iron-icon item-icon icon="icons:clear"></iron-icon>
                            <div class="text">Clear All</div>
                        </paper-icon-item>
                    </div>
                </paper-card>
            </div>
            <div class="tab-page">
                <paper-card heading="Edit Node">
                    <div class="card-content">
                        <paper-input id="node-alias" label="Alias" on-blur="handlePotentialAliasUpdate" on-focus="handlePotentialAliasUpdate" value="{{selectedNode.alias}}"></paper-input>
                        <paper-textarea id="node-description" label="Description" readonly value="{{selectedNode.description}}"></paper-textarea>

                        <paper-icon-item on-click="handleNodeEdit">
                            <iron-icon item-icon icon="icons:code"></iron-icon>
                            <div class="text">Edit Code</div>
                        </paper-icon-item>
                        <paper-icon-item on-click="handleNodeClone">
                            <iron-icon item-icon icon="icons:content-copy"></iron-icon>
                            <div class="text">Clone</div>
                        </paper-icon-item>
                    </div>
                </paper-card>
                <paper-card heading="Edit Project">
                    <div class="card-content">

                        <paper-icon-item on-click="handleProjectEdit">
                            <iron-icon item-icon icon="icons:code"></iron-icon>
                            <div class="text">Edit Code</div>
                        </paper-icon-item>
                    </div>
                </paper-card>
                <paper-card heading="Delete Node">
                    <div class="card-content">

                        <paper-icon-item on-click="handleNodeDelete">
                            <iron-icon item-icon icon="icons:close"></iron-icon>
                            <div class="text">Delete</div>
                        </paper-icon-item>
                    </div>
                </paper-card>
            </div>
            <div class="tab-page">

                <paper-card heading="Export Project">
                    <div class="card-content">

                        <paper-icon-item>
                            <iron-icon item-icon icon="icons:save"></iron-icon>
                            <paper-dropdown-menu label="Export">
                                <paper-listbox slot="dropdown-content" class="dropdown-content">
                                    <paper-item on-click="handleDownloadComposition">Download</paper-item>
                                    <paper-item on-click="handleSubmitComposition">Submit to Repository</paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </paper-icon-item>
                    </div>
                </paper-card>

                <paper-card heading="Export Node">
                    <div class="card-content">
                        <paper-icon-item>
                            <iron-icon item-icon icon="icons:save"></iron-icon>
                            <paper-dropdown-menu label="Export">
                                <paper-listbox slot="dropdown-content" class="dropdown-content">
                                    <paper-item on-click="handleDownloadNode">Download</paper-item>
                                    <paper-item on-click="handleSubmitNode">Submit to Repository</paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </paper-icon-item>
                    </div>
                </paper-card>
            </div>
            <div class="tab-page">
                <paper-card heading="User Settings">
                    <div class="card-content">
                        <paper-input id="user-name" label="Name" value="{{username}}"></paper-input>
                        <paper-item style="padding: 0 !important;">
                            <div class="text">User Color</div>
                            <paper-swatch-picker  color="{{usercolor}}"></paper-swatch-picker>
                        </paper-item>

                        <paper-button raised on-click="handleUserUpdateClick">Update</paper-button>
                    </div>
                </paper-card>
                <paper-card heading="Compilation Settings">
                    <div class="card-content">
                        <paper-toggle-button checked="{{recompile}}" on-change="handleCompilationSetting">Recompile all code locally</paper-toggle-button>
                    </div>
                </paper-card>
            </div>
        </iron-pages>
        <div id="demo-controls" class$="{{_getCollapsedStyle(collapsed)}}">
            <paper-button style="background:#0094ff; margin-bottom: 10px;" on-click="handleOpenVisualizationSelect" class$="{{_getCollapsedStyle(collapsed)}}">Select Visualization</paper-button>
            <paper-button style="background:#ff6a00; text-align: center;" on-click="handleUpdateModel" class$="{{_getCollapsedStyle(collapsed)}}">Update Visualization Model</paper-button>
            <paper-icon-button title="Add Empty Nodes" icon="icons:note-add" on-click="handleCreateNode" class$="{{_getCollapsedStyle(collapsed)}}"></paper-icon-button>
            <paper-icon-button title="Browse Nodes" icon="icons:extension" on-click="handleOpenRepository" class$="{{_getCollapsedStyle(collapsed)}}"></paper-icon-button>
            <!-- <paper-icon-button title="Add Input Node" icon="icons:accessibility" on-click="handleCreateInputNode" class$="{{_getCollapsedStyle(collapsed)}}"></paper-icon-button> -->
            <paper-icon-button title="Select Visualization" style="margin-top:25px;" icon="icons:timeline" on-click="handleOpenVisualizationSelect" class$="{{_getCollapsedStyle(collapsed)}}"></paper-icon-button>
            <paper-icon-button title="Update Visualization Model" style="background:#ff6a00;color:white" icon="icons:input" on-click="handleUpdateModel" class$="{{_getCollapsedStyle(collapsed)}}"></paper-icon-button>
            <paper-icon-button title="Available P2P Devices" style="background:#1572db;color:white" icon="icons:language" on-click="handleP2PDevices" class$="{{_getCollapsedStyle(collapsed)}}"></paper-icon-button>
        </div>
        <paper-dialog id="p2pDevicesDialog">
            <h2>Available P2P Devices</h2>
            <div id="p2pDevicesContent"></div>
            <div class="buttons">
                <paper-button dialog-dismiss>Close</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>
        class SwevaPanel extends Polymer.Element {
          static get is() {
            return 'sweva-panel';
          }

          static get properties() {
            return {
                /* properties meta data object just like 1.x */
              selectedTab: {
                type: Number,
                value: 0
              },
              createNodeAlias: {
                type: String,
                value: ''
              },
              createNodeUrl: {
                type: String,
                value: ''
              },
              selectedNode: {
                type: Object,
                value: null
              },
              progress: {
                type: Number,
                value: 0
              },
              username: {
                type: String,
                value: 'User',
              },
              room: {
                type: String,
                value: '',
              },
              usercolor: {
                type: String,
                value: "#009688"
              },
              collapsed: {
                type: Boolean,
                value: true
              }
            }
          }

          ready() {
            super.ready();
            Polymer.RenderStatus.beforeNextRender(this, function() {
              this.collapse();
            });
          }

          _getCollapsedStyle(collapsed) {
            if (collapsed) {
              return 'hidden'
            }
            return '';
          }

          handleP2PDevices() {

              sweva.ExecutionManager.getListOfPeers().then ((listOfPeers)=>{
                  let popupWindow = window.open('', 'Available P2P Devices', 'width=400,height=300,toolbar=no');
                  let popupDocument = popupWindow.document;

                  popupDocument.write('<html><body>');
                  popupDocument.write('<h3>Available P2P Devices =</h3><br>');

                  popupDocument.write('<ol>');
                  for (let i = 0; i < listOfPeers.length; i++) {
                      popupDocument.write('<li>' + listOfPeers[i] + '</li>');
                  }
                  popupDocument.write('</ol>');

                  popupDocument.write('</body></html>');
                  popupDocument.close();

              });
          }

          handleCreateInputNode() {
            this.dispatchEvent(new CustomEvent('createinputnode', { bubbles: true, composed: true}));
          }

          handleOpenVisualizationSelect() {
            this.dispatchEvent(new CustomEvent('openvisualizationselect', { bubbles: true, composed: true}));
          }

          handleUpdateModel() {
            this.dispatchEvent(new CustomEvent('updatemodel', { bubbles: true, composed: true , detail:{} }));
          }

          handleCollapse() {
            this.collapsed = !this.collapsed;
            this.collapse();
          }

          collapse() {
            if (!this.collapsed) {
              this.style.width = 230 + 'px';
            }
            else {
              this.style.width = 40 + 'px';
            }
            this.dispatchEvent(new CustomEvent('collapsed', { bubbles: true, composed: true , detail: this.collapsed }));
          }

          handlePotentialAliasUpdate (event) {
            var input = this.shadowRoot.querySelector('#node-alias');
            if (input && this.selectedNode) {
              if (input.value != this.selectedNode.alias) {
                input.value = this.selectedNode.alias;
              }
            }
          }

          handleOpenRepository() {
            this.dispatchEvent(new CustomEvent('repositorybrowse', { bubbles: true, composed: true , detail: { category: 'modules', callback: this.setUrlAndCreate.bind(this) } }));
          }

          handleSwitchRoom() {
            this.dispatchEvent(new CustomEvent('switchroom', { bubbles: true, composed: true , detail: this.room }));
          }

          updateRoom(room) {
            this.room = room;
          }

          handleAutoLayout() {
            this.dispatchEvent(new CustomEvent('autolayout', { bubbles: true, composed: true , detail: {}}));
          }

          handleImportExportDialogAccepted(event) {
            if (event.detail.mode != 'export') {
              this.dispatchEvent(new CustomEvent('imported', { bubbles: true, composed: true , detail: { alias: this.createNodeAlias, mode: event.detail.mode, content: event.detail.content }}));
            }
          }

          handleImportNodeJSON() {
            var dialog = this.shadowRoot.querySelector('#import-export-dialog');
            if (dialog) {
              dialog.openImport('importNodeJson', 'Import Node as JSON');
            }
          }

          handleImportNodeObject() {
            var dialog = this.shadowRoot.querySelector('#import-export-dialog');
            if (dialog) {
              dialog.openImport('importNodeObject', 'Import Node as Object');
            }
          }

          handleImportCompositionJSON() {
            var dialog = this.shadowRoot.querySelector('#import-export-dialog');
            if (dialog) {
              dialog.openImport('importCompositionJSON', 'Import Project as JSON');
            }
          }

          handleImportCompositionObject() {
            var dialog = this.shadowRoot.querySelector('#import-export-dialog');
            if (dialog) {
              dialog.openImport('importCompositionObject', 'Import Project as Object');
            }
          }

          handleNodeDelete() {
            this.dispatchEvent(new CustomEvent('deletenode', { bubbles: true, composed: true , detail:  this.selectedNode}));
          }

          handleClearAll() {
            this.dispatchEvent(new CustomEvent('clearall', { bubbles: true, composed: true , detail: {}}));
          }

          handleNodeEdit() {
            this.dispatchEvent(new CustomEvent('editnode', { bubbles: true, composed: true , detail: this.selectedNode}));
          }

          handleNodeClone() {
            this.dispatchEvent(new CustomEvent('clonenode', { bubbles: true, composed: true , detail: this.selectedNode}));
          }

          handleNodeUpdate() {

          }

          handleProjectEdit() {
            this.dispatchEvent(new CustomEvent('editproject', { bubbles: true, composed: true , detail: this.selectedNode}));
          }

          handleProjectUpdate() {

          }

          handleDownloadComposition() {
            this.dispatchEvent(new CustomEvent('downloadproject', { bubbles: true, composed: true}));
          }

          handleSubmitComposition() {

          }

          handleDownloadNode() {
            if (this.selectedNode) {
              downloadAsFile({
                data: this.selectedNode.toJSON(),
                filename: (this.selectedNode.name || 'node') + '.json'
              });
            }
          }

          handleSubmitNode() {

          }

          handleCreateInputNode() {
            this.dispatchEvent(new CustomEvent('createinputnode', { bubbles: true, composed: true , detail: {}}));
          }

          handleCreateNode() {
            var alias = this.createNodeAlias;
            this.dispatchEvent(new CustomEvent('createnode', { bubbles: true, composed: true , detail: { alias: alias, url: '' }}));
          }

          handleCreateNodeUrl(event, a, fixed) {
            var alias = this.createNodeAlias;
            var url = this.createNodeUrl;
            if (url.trim().length == 0) {
              url = '';
            }
            var fix = false;
            if (typeof fixed !== 'undefined' && fixed) {
              fix = true;
            }
            this.dispatchEvent(new CustomEvent('createnode', { bubbles: true, composed: true , detail:  { alias: alias, url: url, fixed: fix }}));
          }

          handleCreateNodeUrlFixed(event, a) {
            this.handleCreateNodeUrl(event, a, true);
          }

            handleUserUpdateClick() {
                this.dispatchEvent(new CustomEvent('userdatachanged', { bubbles: true, composed: true , detail: {
                        name: this.username,
                        color: this.usercolor
                    }}));
            }
            handleCompilationSetting() {
              console.log(this)
                this.dispatchEvent(new CustomEvent('userdatachanged', { bubbles: true, composed: true , detail: {
                        recompile: this.recompile
                    }}));
            }

          updateNode(node) {
            this.selectedNode = node;
          }

          setUrl(url) {
            this.createNodeUrl = url;
          }

          setUrlAndCreate(url) {
            this.setUrl(url);
            this.handleCreateNodeUrl();
          }

          updateUser(data) {
            if (data.name) {
              this.username = data.name;
            }
            if (data.color) {
              this.usercolor = data.color;
            }
          }
        }

        // Register custom element definition using standard platform API
        customElements.define(SwevaPanel.is, SwevaPanel);
    </script>
</dom-module>