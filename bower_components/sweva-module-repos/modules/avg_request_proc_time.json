{
    "type": "module",
    "name": "avg_requst_proc_time",
    "description": "Retrieves average request processing time by dates from MobSOS.",
    "dataInNames": [
        "startDate",
        "endDate"
    ],
    "dataInSchema": {},
    "dataOutNames": [
        "result"
    ],
    "dataOutSchema": {},
    "inputNames": [],
    "inputSchema": {},
    "request": [
	"function (data, input, libs) {",
     "",   
        "var where = '';",
        "if(data.startDate > 0 && data.endDate > 0) {",
            "where = \"WHERE UNIX_TIMESTAMP(time) BETWEEN \" +",
            "data.startDate + \" AND \" + data.endDate + \" \";",
        "}",
        "",
        "var groupByDate = '%y-%m-%d-%H';",
        "",
        "",
        "if (input.granularity == \"month\") {",
            "groupByDate = '%y-%m';",
        "}",
        "else if (input.granularity == \"day\") {",
            "groupByDate = '%y-%m-%d';",
        "}",
        "",
        "",
        "var query =\"select  UNIX_TIMESTAMP(time) as t, avg(request_time) avg_reqtime\"+",
        "\" from log \"+",
        "where +",
        "\"group by DATE_FORMAT(time, '\" + groupByDate + \"') \"+",
        "\"ORDER BY t ASC\";",
        "return libs.axios.post('https://api.learning-layers.eu/mobsos-qv/QVS/query/visualize?access_token=a&format=JSON',",
        "{",
            "\"query\": query,",
        "\"queryparams\":new Array(),",
        "\"dbkey\":\"Layers Box\",",
        "\"cache\":false,",
        "\"modtypei\":0,",
        "\"title\":\"Avg Request Processing Time - Timeline\",",
        "\"width\":\"500\",",
        "\"height\":\"300\"",
        "});",
    "}"
	],
   "response": [
        "function (response, input, libs) {",
        "",
        "var data = new Array();",
        "response.data.forEach(function(element, i) {",
        "if (i<2) {",
        "return;",
        "}",
        "var time = libs.get(element, 0);",
        "libs.set(element, 0, (time)*1000);",
        "data.push(element);",
        "});",
        "",
        "",
        "return {result: response.data.slice(2)};",
        "}"
    ]
}