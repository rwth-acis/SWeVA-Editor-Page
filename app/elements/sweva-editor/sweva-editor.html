<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="sweva-node.html">
<link rel="import" href="sweva-canvas.html">
<link rel="import" href="sweva-panel.html">

<dom-module id="sweva-editor">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: flex;
                height: 100%;
                position: relative;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */
                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;
                padding: 10px;
            }
            sweva-canvas {
               
                flex: 1 1 auto;
            }
            sweva-panel {
               
                flex: 0 0 auto;
            }
        </style>

        <sweva-canvas id="canvas-container">
            <sweva-node name="Node1" id="node1" pos-x="2050" pos-y="2050"></sweva-node>
            <sweva-node name="Node2" id="node2" pos-x="2250" pos-y="2150"></sweva-node>
        </sweva-canvas>
        <sweva-panel>

        </sweva-panel>
    </template>

    <!-- <link href="https://jsplumbtoolkit.com/community/demo/flowchart/app.css" rel="stylesheet" />-->
    <script src="../../../bower_components/yjs/yjs.js"></script>
    <script src="../../../bower_components/jsplumb/dist/js/jsPlumb-2.1.0.js"></script>
    <script>

        (function () {
            'use strict';

            Polymer({
                is: 'sweva-editor',
                properties: {
                    jsPlumbInstance: {
                        type: Object,
                        value: null
                    }
                },
                attached: function () {
                    var self = this;
                    jsPlumb.ready(function () {

                        var instance = window.jsp = jsPlumb.getInstance({
                            // default drag options
                            DragOptions: { cursor: 'pointer', zIndex: 2000 },
                            // the overlays to decorate each connection with.  note that the label overlay uses a function to generate the label text; in this
                            // case it returns the 'labelText' member that we set on each connection in the 'init' method below.
                            ConnectionOverlays: [
                                ["PlainArrow", { location: 1 }]
                            ],
                            Container: "canvas"
                        });
                        self.jsPlumbInstance = instance;
                        self.querySelector('#canvas-container').jsPlumbInstance = instance;
                        var nodeConnectorPaintStyle = {
                            lineWidth: 4,
                            strokeStyle: "#0094ff",
                            joinstyle: "round",
                            outlineColor: "white",
                            outlineWidth: 2,
                            gradient: {
                                stops: [[0, "#ff9d00"], [1, "#0094ff"]]
                            }
                        }
                        // .. and this is the hover style.
                        var nodeConnectorHoverStyle = {
                            lineWidth: 4,
                            strokeStyle: "#00cc00",
                            outlineWidth: 2,
                            outlineColor: "#00cc00",
                            gradient: {
                                stops: [[0, "#00cc00"], [1, "#00cc00"]]
                            }
                        }
                        var nodeEndpointHoverStyle = {
                            fillStyle: "#00cc00",
                            strokeStyle: "#00cc00"
                        }

                        var nodeDataOutEndpoint = {
                            endpoint: "Dot",
                            paintStyle: {
                                strokeStyle: "#ff9d00",
                                fillStyle: "#ff9d00",
                                radius: 10,
                                lineWidth: 4
                            },

                            isSource: true,
                            connector: ["Bezier"],
                            connectorStyle: nodeConnectorPaintStyle,
                            hoverPaintStyle: nodeEndpointHoverStyle,
                            connectorHoverStyle: nodeConnectorHoverStyle,
                            dragOptions: {},
                            overlays: [
                                ["Label", {
                                    location: [0, -0.5],
                                    label: "Dragavdfbdfhg fghfgh fg ",
                                    cssClass: "node-data-out-endpoint-label node-label sweva-editor"
                                }]
                            ]
                        }

                        var nodeDataInEndpoint = {
                            endpoint: "Dot",
                            paintStyle: {
                                strokeStyle: "#0094ff",
                                fillStyle: "#ffffff",
                                radius: 10,
                                lineWidth: 4
                            },
                            hoverPaintStyle: nodeEndpointHoverStyle,
                            maxConnections: 1,
                            dropOptions: { hoverClass: "hover", activeClass: "active" },
                            isTarget: true,
                            overlays: [
                                ["Label", {
                                    location: [0.5, -0.5],
                                    label: "Drop",
                                    cssClass: "node-data-in-endpoint-label node-label sweva-editor"
                                }]
                            ]
                        }

                        var init = function (connection) {
                            //  connection.getOverlay("label").setLabel(connection.sourceId.substring(15) + "-" + connection.targetId.substring(15));
                        };

                        var _addEndpoints = function (toId, sourceAnchors, targetAnchors) {
                            for (var i = 0; i < sourceAnchors.length; i++) {
                                var sourceUUID = toId + sourceAnchors[i];
                                instance.addEndpoint("flowchart" + toId, sourceEndpoint, {
                                    anchor: sourceAnchors[i], uuid: sourceUUID
                                });
                            }
                            for (var j = 0; j < targetAnchors.length; j++) {
                                var targetUUID = toId + targetAnchors[j];
                                instance.addEndpoint("flowchart" + toId, targetEndpoint, { anchor: targetAnchors[j], uuid: targetUUID });
                            }
                        };

                        // suspend drawing and initialise.
                        instance.batch(function () {
                            instance.addEndpoint('node1', nodeDataInEndpoint, {
                                anchor: [0, 0.5, -1, 0],
                                uuid: 'node1_12'
                            });
                            instance.addEndpoint('node1', nodeDataOutEndpoint, {
                                anchor: [1, 0.5, 1, 0],
                                uuid: 'node1_13'
                            });

                            instance.addEndpoint('node2', nodeDataInEndpoint, {
                                anchor: [0, 0.5, -1, 0],
                                uuid: 'node2_12'
                            });
                            instance.addEndpoint('node2', nodeDataOutEndpoint, {
                                anchor: [1, 0.5, 1, 0],
                                uuid: 'node2_13'
                            });

                            // listen for new connections; initialise them the same way we initialise the connections at startup.
                            instance.bind("connection", function (connInfo, originalEvent) {
                                init(connInfo.connection);
                            });

                            // make all the window divs draggable

                            instance.draggable(jsPlumb.getSelector('sweva-node'), { grid: [20, 20] });

                            instance.draggable(jsPlumb.getSelector(".flowchart-demo .window"), { grid: [20, 20] });
                            // THIS DEMO ONLY USES getSelector FOR CONVENIENCE. Use your library's appropriate selector
                            // method, or document.querySelectorAll:
                            //jsPlumb.draggable(document.querySelectorAll(".window"), { grid: [20, 20] });

                            // connect a few up
                            instance.connect({ uuids: ["node1_13", "node2_12"], editable: true });

                            //
                            // listen for clicks on connections, and offer to delete connections on click.
                            //
                            instance.bind("click", function (conn, originalEvent) {
                                // if (confirm("Delete connection from " + conn.sourceId + " to " + conn.targetId + "?"))
                                //   instance.detach(conn);
                                conn.toggleType("basic");
                            });

                            instance.bind("connectionDrag", function (connection) {
                                console.log("connection " + connection.id + " is being dragged. suspendedElement is ", connection.suspendedElement, " of type ", connection.suspendedElementType);
                            });

                            instance.bind("connectionDragStop", function (connection) {
                                console.log("connection " + connection.id + " was dragged");
                            });

                            instance.bind("connectionMoved", function (params) {
                                console.log("connection " + params.connection.id + " was moved");
                            });
                        });

                        jsPlumb.fire("jsPlumbDemoLoaded", instance);

                    });
                }

            });
        })();
    </script>
</dom-module>