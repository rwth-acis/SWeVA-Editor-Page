<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="sweva-node.html">
<link rel="import" href="sweva-canvas.html">
<link rel="import" href="sweva-panel.html">
<link rel="import" href="sweva-code.html">
<link rel="import" href="sweva-cursor-awareness.html">
<link rel="import" href="sweva-user-manager.html">
<link rel="import" href="sweva-chat.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<dom-module id="sweva-editor">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: flex;
                height: 100%;
                position: relative;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */
                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;
                padding: 10px;
            }

            sweva-canvas {
                flex: 1 1 auto;
            }

            sweva-panel {
                flex: 0 0 auto;
            }

            #editor-dialog {
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                margin: 50px;
                padding-top: 50px;
                position: fixed;
                width: 100%;
            }

            paper-dialog {
                background: #fff;
            }
        </style>

        <sweva-canvas id="canvas-container" 
                      canvas-offset-x="{{canvasOffset.x}}" 
                      canvas-offset-y="{{canvasOffset.x}}" 
                      on-canvasmousemove="handleCanvasMouseMove"
                      on-viewportchanged="handleViewPortChanced">

            <sweva-cursor-awareness id="cursor-awareness"></sweva-cursor-awareness>
           
        </sweva-canvas>
        <sweva-chat></sweva-chat>
        <sweva-panel
                     on-createnode="handleCreateNode" 
                     on-autolayout="handleAutoLayout"
                     on-userdatachanged="handleUserDataChanged">
        </sweva-panel>
        <sweva-user-manager on-useradded="handleUserAdded" on-userupdated="handleUserUpdated">
        </sweva-user-manager>
        <paper-dialog id="editor-dialog">
            <h2>Dialog Title</h2>
            <sweva-code>
            </sweva-code>
        </paper-dialog>
    </template>

    <script src="../../../bower_components/yjs/yjs.js"></script>
    <script src="../../../bower_components/jsplumb/dist/js/jsPlumb-2.1.0.js"></script>

    <script src="https://cdn.rawgit.com/cpettitt/dagre/master/dist/dagre.js"></script>

    <!--<script src="../../../bower_components/dagre/dist/dagre.core.min.js"></script>
    <!--<script src="../../../bower_components/graphlib/dist/graphlib.core.min.js"></script>-->
    <script>

        (function () {
            'use strict';

            Polymer({
                is: 'sweva-editor',
                properties: {
                    jsPlumbInstance: {
                        type: Object,
                        value: null
                    },
                    yjs: {
                        type: Object,
                        value: null
                    },
                    canvasOffset: {
                        type: Object,
                        value: {
                            x: -2000,
                            y: -2000
                        }
                    }
                },
                getGraphData: function () {
                    var nodes = this.querySelectorAll('sweva-node');
                    var edges = [];

                    this.jsPlumbInstance.select().each(function (connection) {
                        var edge = {};
                        edge.from = connection.sourceId;
                        edge.to = connection.targetId;

                        if (connection.endpoints.length != 2) {
                            return;
                        }

                        var labels = connection.endpoints[0].getOverlays();
                        for (var key in labels) {
                            if (labels.hasOwnProperty(key)) {
                                edge.fromEndpoint = labels[key].label;
                            }
                        }

                        labels = connection.endpoints[1].getOverlays();
                        for (var key in labels) {
                            if (labels.hasOwnProperty(key)) {
                                edge.toEndpoint = labels[key].label;
                            }
                        }
                        edges.push(edge);
                    });

                    return { nodes: nodes, edges: edges };
                },
                autoLayout: function () {
                    var graph = this.getGraphData();
                    var g = new dagre.graphlib.Graph();
                    g.setGraph({});
                    g.setDefaultEdgeLabel(function () { return {}; });
                    var nodeDictionary = {};
                    for (var i = 0; i < graph.nodes.length; i++) {
                        nodeDictionary[graph.nodes[i].id] = i;
                        g.setNode(i, { width: graph.nodes[i].offsetWidth, height: graph.nodes[i].offsetHeight });
                    }

                    for (var i = 0; i < graph.edges.length; i++) {
                        g.setEdge(nodeDictionary[graph.edges[i].from], nodeDictionary[graph.edges[i].to]);
                    }

                    g.setGraph({ rankdir: 'LR', nodesep: 140, ranksep: 300 })
                    dagre.layout(g);

                    var canvasOffset = this.canvasOffset;

                    g.nodes().forEach(function (v) {
                        if (typeof v !== 'undefined' && v !== 'undefined') {

                            var node = g.node(v);
                            var realNode = graph.nodes[v];

                            realNode.posX = -canvasOffset.x + node.x;
                            realNode.posY = -canvasOffset.y + node.y;
                            realNode.updatePos();

                        }
                    });

                    this.jsPlumbInstance.repaintEverything();
                },
                handleCanvasMouseMove: function (event) {
                    var position = event.detail;
                    var userManager = this.querySelector('sweva-user-manager');
                    
                    userManager.updateCursor(position.x, position.y);
                },
                handleViewPortChanced: function (event) {
                    var cursors = this.querySelector('#cursor-awareness');
                    cursors.updateViewport(event.detail);
                },              
                    
                handleUserAdded: function (event) {
                    if (!event.detail.isSelf) {
                        var cursors = this.querySelector('#cursor-awareness');
                        cursors.add(event.detail);
                    }
                    
                },
                handleUserUpdated: function (event) {                    
                    var cursors = this.querySelector('#cursor-awareness');
                    cursors.update(event.detail.id, event.detail);

                    if (event.detail.isSelf && (event.detail.name || event.detail.color)) {
                        var panel = this.querySelector('sweva-panel');
                        panel.updateUser(event.detail);

                        var chat = this.querySelector('sweva-chat');
                        chat.updateUser(event.detail);
                    }
                },
                handleUserDataChanged: function (event) {
                    var userManager = this.querySelector('sweva-user-manager');
                    userManager.update(userManager.ownId, event.detail);
                },
                handleAutoLayout: function (event) {

                    /*this.autoLayout();

                    var dialog = this.querySelector('#editor-dialog');
                    if (dialog) {
                        //dialog.open();
                    }*/

                },
                handleCreateNode: function (event) {
                    this.createNode({ name: event.detail.name });

                },
                createNode: function (options) {

                    var canvas = this.querySelector('#canvas-container');

                    var node = document.createElement("sweva-node");
                    Polymer.dom(canvas).appendChild(node)

                    var center = canvas.getViewCenter();

                    var composableJSON = {
                        name: options.name
                    }

                    var x = options.x || center.x;
                    var y = options.y || center.y;

                    node.init(this.jsPlumbInstance, this.yjs, composableJSON, { x: x, y: y });
                    return node;

                },
                yjsCreateNode: function (nodeData) {

                    var canvas = this.querySelector('#canvas-container');

                    var node = document.createElement("sweva-node");
                    Polymer.dom(canvas).appendChild(node)

                    node.init(this.jsPlumbInstance, this.yjs, {}, { x: nodeData.x, y: nodeData.y }, nodeData.id, true);

                    return node;

                },
                ready: function () {
                    var self = this;
                   

                    Y({
                        db: {
                            name: 'memory'
                        },
                        connector: {
                            name: 'websockets-client',
                            room: 'swevatest9'
                            // debug: true,
                            // url: 'http://127.0.0.1:2345'
                        },
                        sourceDir: 'http://127.0.0.1:8021/SWeVA-Editor-Page/bower_components',
                        share: {
                            //nodes: 'Map',
                            nodes: 'Map',
                            users: 'Map',
                            chat: 'Array'
                        }
                    }).then(function (y) {
                        self.yjs = y;
                        var yjs = y;

                        yjs.share.nodes.observe(function (events) {

                            for (var i = 0; i < events.length; i++) {
                                var event = events[i];
                                (function (event) {
                                    console.log('event', event.name, event.type);

                                    if (event.type === 'add') {
                                        yjs.share.nodes.get(event.name).then(function (map) {
                                            var position = map.get('position') || { x: 0, y: 0 };
                                            self.yjsCreateNode({ id: event.name, x: position.x, y: position.y });
                                            self.jsPlumbInstance.repaintEverything();

                                            map.observe(function () {

                                                var position = map.get('position') || { x: 0, y: 0 };
                                                var node = document.getElementById(event.name);

                                                if (!node) {
                                                    return;
                                                }
                                                node.posX = position.x;
                                                node.posY = position.y;
                                                self.jsPlumbInstance.repaintEverything();
                                            });
                                        });
                                    }

                                })(event);
                            }
                        });
                       
                        var userManager = self.querySelector('sweva-user-manager');
                        userManager.init(yjs);
                        var userChat = self.querySelector('sweva-chat');
                        userChat.init(yjs);

                        console.log('loaded');
                    });

                },
                attached: function () {
                    var self = this;

                    jsPlumb.ready(function () {

                        var instance = window.jsp = jsPlumb.getInstance({
                            // default drag options
                            DragOptions: { cursor: 'pointer', zIndex: 2000 },
                            // the overlays to decorate each connection with.  note that the label overlay uses a function to generate the label text; in this
                            // case it returns the 'labelText' member that we set on each connection in the 'init' method below.
                            ConnectionOverlays: [
                                ["PlainArrow", { location: 1 }]
                            ],
                            Container: "canvas"
                        });
                        self.jsPlumbInstance = instance;
                        self.querySelector('#canvas-container').jsPlumbInstance = instance;

                        var init = function (connection) {
                            //  connection.getOverlay("label").setLabel(connection.sourceId.substring(15) + "-" + connection.targetId.substring(15));
                        };

                        // suspend drawing and initialise.
                        instance.batch(function () {

                            // listen for new connections; initialise them the same way we initialise the connections at startup.
                            instance.bind("connection", function (connInfo, originalEvent) {
                                init(connInfo.connection);
                            });

                            // make all the window divs draggable

                            instance.draggable(jsPlumb.getSelector('sweva-node'), { grid: [20, 20] });

                            instance.draggable(jsPlumb.getSelector(".flowchart-demo .window"), { grid: [20, 20] });
                            // THIS DEMO ONLY USES getSelector FOR CONVENIENCE. Use your library's appropriate selector
                            // method, or document.querySelectorAll:
                            //jsPlumb.draggable(document.querySelectorAll(".window"), { grid: [20, 20] });

                            // connect a few up
                            // instance.connect({ uuids: ["node1_13", "node2_12"], editable: true });

                            //
                            // listen for clicks on connections, and offer to delete connections on click.
                            //
                            instance.bind("click", function (conn, originalEvent) {
                                // if (confirm("Delete connection from " + conn.sourceId + " to " + conn.targetId + "?"))
                                //   instance.detach(conn);
                                conn.toggleType("basic");
                            });

                            instance.bind("connectionDrag", function (connection) {
                                console.log("connection " + connection.id + " is being dragged. suspendedElement is ", connection.suspendedElement, " of type ", connection.suspendedElementType);
                            });

                            instance.bind("connectionDragStop", function (connection) {
                                console.log("connection " + connection.id + " was dragged");
                                console.log(connection);
                            });

                            instance.bind("connectionMoved", function (params) {
                                console.log("connection " + params.connection.id + " was moved");
                            });
                        });

                        jsPlumb.fire("jsPlumbDemoLoaded", instance);
                        // self.createNode({ name: 'node1', x: 2050, y: 2050});

                        /*setTimeout(function () {

                            var nodes = [];
                            for (var i = 0; i < 10; i++) {

                                nodes.push(self.createNode({ name: 'node' + i, x: 2000 + Math.random() * 1000, y: 2000 + Math.random() * 1000 }));

                            }

                            instance.connect({ uuids: [nodes[1].id + 'OUT1', nodes[2].id + 'IN1'], editable: true });
                            instance.connect({ uuids: [nodes[2].id + 'OUT1', nodes[3].id + 'IN1'], editable: true });
                            instance.connect({ uuids: [nodes[4].id + 'OUT1', nodes[5].id + 'IN1'], editable: true });
                            instance.connect({ uuids: [nodes[4].id + 'OUT2', nodes[3].id + 'IN2'], editable: true });

                        }, 2000);*/

                    });

                }

            });
        })();
    </script>
</dom-module>