<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="sweva-node.html">
<link rel="import" href="sweva-canvas.html">
<link rel="import" href="sweva-panel.html">

<dom-module id="sweva-editor">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: flex;
                height: 100%;
                position: relative;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */
                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;
                padding: 10px;
            }

            sweva-canvas {
                flex: 1 1 auto;
            }

            sweva-panel {
                flex: 0 0 auto;
            }
        </style>

        <sweva-canvas id="canvas-container" canvas-offset-x="{{canvasOffset.x}}" canvas-offset-x="{{canvasOffset.x}}">
            <!--<sweva-node name="Node1" id="node1" pos-x="2050" pos-y="2050"></sweva-node>
            <sweva-node name="Node2" id="node2" pos-x="2250" pos-y="2150"></sweva-node>-->
        </sweva-canvas>
        <sweva-panel on-createnode="handleCreateNode">
        </sweva-panel>
    </template>

    
    <script src="../../../bower_components/yjs/yjs.js"></script>
    <script src="../../../bower_components/jsplumb/dist/js/jsPlumb-2.1.0.js"></script>
    <script>

        (function () {
            'use strict';

            Polymer({
                is: 'sweva-editor',
                properties: {
                    jsPlumbInstance: {
                        type: Object,
                        value: null
                    },
                    canvasOffset: {
                        type: Object,
                        value: {
                            x: -2000,
                            y: -2000
                        }
                    }
                },
                
                handleCreateNode: function (event) {
                    this.createNode({ name: event.detail.name });
                    
                },
                createNode: function (options) {                   
                    
                    var canvas = this.querySelector('#canvas-container');
                    var canvasView = this.querySelector('#canvas-view');
                    var node = document.createElement("sweva-node");
                    Polymer.dom(canvas).appendChild(node)

                    var center = canvas.getViewCenter();
                  
                    
                    var composableJSON = {
                        name: options.name
                    }

                    var x = options.x || center.x;
                    var y = options.y || center.y;
                    console.log(this.yjs);
                    node.init(this.jsPlumbInstance, this.yjs, composableJSON, { x: x, y: y });
                    
                   
                },
                ready: function () {
                    var self = this;
                    return;
                    Y({
                        db: {
                            name: 'memory'
                        },
                        connector: {
                            name: 'websockets-client',
                            room: 'swevatest'
                            // debug: true,
                            // url: 'http://127.0.0.1:2345'
                        },
                        sourceDir: 'http://127.0.0.1:8021/SWeVA-Editor-Page/bower_components',
                        share: {
                            //nodes: 'Map',
                            nodes: 'Map'
                        }
                    }).then(function (y) {
                        self.yjs = y;
                        var yjs = y;
                        window.yjs = y;
                        yjs.share.nodes.observe(function (events) {
                            for (var i = 0; i < events.length; i++) {
                                var event = events[i];
                                (function (event) {
                                    if (event.type !== 'delete') {
                                        yjs.share.nodes.get(event.name).then(function (map) {
                                            map.observe(function () {

                                                var position = map.get('position') || { x: 100, y: 50 };
                                                var node = self.querySelector('#' + event.name);
                                                node.posX = position.x;
                                                node.posY = position.y;
                                                console.log(position);
                                                self.jsPlumbInstance.repaintEverything();
                                            });

                                        });

                                    }
                                })(event);
                            }
                        });
                        /*
                        y.share.piece1.observe(function () {

                            var position = self.yjs.share.piece1.get('position') || { x: 100, y: 50 };
                            var node = self.querySelector('#asdas');
                            node.posX = position.x;
                            node.posY = position.y;
                            console.log(position)
                            self.jsPlumbInstance.repaintEverything();
                        });
                      /*  y.share.piece1.observe(function () {
                            var position = y.share.piece1.get('position') || { x: 100, y: 50 };
                            var node = self.querySelector('#node123');
                            node.style.left = position.x + 'px';
                            node.style.top = position.y + 'px';
                            self.jsPlumbInstance.repaintEverything();



                            //.then(function (value) {
                            //var node = self.querySelector('#jsPlumb_2_3');
                            /*
                            node.style.left = value.x + 'px';
                            node.style.top = value.y + 'px';
                            self.instance.repaintEverything();*/

                            // });
                       // });
                        console.log('yjs loaded')
                    })
                },
                attached: function () {
                    var self = this;
                    jsPlumb.ready(function () {

                        var instance = window.jsp = jsPlumb.getInstance({
                            // default drag options
                            DragOptions: { cursor: 'pointer', zIndex: 2000 },
                            // the overlays to decorate each connection with.  note that the label overlay uses a function to generate the label text; in this
                            // case it returns the 'labelText' member that we set on each connection in the 'init' method below.
                            ConnectionOverlays: [
                                ["PlainArrow", { location: 1 }]
                            ],
                            Container: "canvas"
                        });
                        self.jsPlumbInstance = instance;
                        self.querySelector('#canvas-container').jsPlumbInstance = instance;
                        
                        
                        var init = function (connection) {
                            //  connection.getOverlay("label").setLabel(connection.sourceId.substring(15) + "-" + connection.targetId.substring(15));
                        };

                     

                        // suspend drawing and initialise.
                        instance.batch(function () {
                            

                            // listen for new connections; initialise them the same way we initialise the connections at startup.
                            instance.bind("connection", function (connInfo, originalEvent) {
                                init(connInfo.connection);
                            });

                            // make all the window divs draggable

                            instance.draggable(jsPlumb.getSelector('sweva-node'), { grid: [20, 20] });

                            instance.draggable(jsPlumb.getSelector(".flowchart-demo .window"), { grid: [20, 20] });
                            // THIS DEMO ONLY USES getSelector FOR CONVENIENCE. Use your library's appropriate selector
                            // method, or document.querySelectorAll:
                            //jsPlumb.draggable(document.querySelectorAll(".window"), { grid: [20, 20] });

                            // connect a few up
                           // instance.connect({ uuids: ["node1_13", "node2_12"], editable: true });

                            //
                            // listen for clicks on connections, and offer to delete connections on click.
                            //
                            instance.bind("click", function (conn, originalEvent) {
                                // if (confirm("Delete connection from " + conn.sourceId + " to " + conn.targetId + "?"))
                                //   instance.detach(conn);
                                conn.toggleType("basic");
                            });

                            instance.bind("connectionDrag", function (connection) {
                                console.log("connection " + connection.id + " is being dragged. suspendedElement is ", connection.suspendedElement, " of type ", connection.suspendedElementType);
                            });

                            instance.bind("connectionDragStop", function (connection) {
                                console.log("connection " + connection.id + " was dragged");
                                console.log(connection);
                            });

                            instance.bind("connectionMoved", function (params) {
                                console.log("connection " + params.connection.id + " was moved");
                            });
                        });

                        jsPlumb.fire("jsPlumbDemoLoaded", instance);
                        // self.createNode({ name: 'node1', x: 2050, y: 2050});

                        setTimeout(function () {

                            for (var i = 0; i < 10; i++) {
                                self.createNode({ name: 'node'+i, x: 2000+Math.random()*1000, y: 2000+Math.random()*1000});
                            }
                           
                        }, 10);
                        

                        
                    });


                }

            });
        })();
    </script>
</dom-module>