<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="sweva-node.html">
<link rel="import" href="sweva-canvas.html">
<link rel="import" href="sweva-panel.html">
<link rel="import" href="sweva-code.html">
<link rel="import" href="sweva-cursor-awareness.html">
<link rel="import" href="sweva-user-manager.html">
<link rel="import" href="sweva-chat.html">
<link rel="import" href="sweva-node-manager.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<dom-module id="sweva-editor">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: flex;
                height: 100%;
                position: relative;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */
                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;
                padding: 10px;
            }

            sweva-canvas {
                flex: 1 1 auto;
            }

            sweva-panel {
                flex: 0 0 auto;
            }

            .dialog-container {
                display: flex;
                flex-direction: column;
                height: 100%;
                width: 100%;
                box-sizing: border-box;
                padding-bottom: 25px;
            }

            paper-dialog {
                background: #fff;
            }
        </style>

        <sweva-canvas id="canvas-container"
                      canvas-offset-x="{{canvasOffset.x}}"
                      canvas-offset-y="{{canvasOffset.x}}"
                      on-canvasmousemove="handleCanvasMouseMove"
                      on-viewportchanged="handleViewPortChanced">

            <sweva-cursor-awareness id="cursor-awareness"></sweva-cursor-awareness>
            <sweva-node-manager canvas-offset="{{canvasOffset}}"
                                on-jsplumbloaded="handleJsPlumbLoaded"
                                on-nodeselected="handleNodeSelection"
                                on-editnode="handleEditNode"
                                on-deletenode="handleDeleteNode"
                                repository-address="{{repositoryAddress}}"
                                repository-suffix="{{repositorySuffix}}">
                
            </sweva-node-manager>
        </sweva-canvas>

        <sweva-chat></sweva-chat>
        <sweva-panel on-createnode="handleCreateNode"
                     on-autolayout="handleAutoLayout"
                     on-userdatachanged="handleUserDataChanged"
                     on-deletenode="handleDeleteNode"
                     on-clearall="handleClearAll"
                     on-imported="handleImported"
                     on-editnode="handleEditNode"
                     on-editproject="handleEditProject"
                     on-execute="handleExecute"
                     on-editdata="handleEditData"
                     on-editinput="handleEditInput"
                     on-downloadproject="handleDownloadProject"
                     on-generateinputdata="handleGenerateInputData"
                     on-switchroom="handleSwitchRoom">
        </sweva-panel>
        <sweva-user-manager on-useradded="handleUserAdded"
                            on-userdeleted="handleUserDeleted"
                            on-userupdated="handleUserUpdated">
        </sweva-user-manager>
        <sweva-code id="editor-dialog"
                    on-edited="handleEditComplete">
        </sweva-code>
    </template>

    <script src="../../../bower_components/yjs/y.js"></script>
    <script>
        if (!window.module) {
            window.module = {};
        }</script>
    <!--<script src="https://rawgit.com/y-js/y-memory/dist/y-memory.js"></script>
    <script src="https://cdn.rawgit.com/y-js/y-array/master/src/Array.js"></script>
    <script src="https://cdn.rawgit.com/y-js/y-text/master/src/Text.js"></script>
    <script src="https://rawgit.com/y-js/y-memory/dist/y-memory.js"></script>
    <!-- <script src="https://rawgit.com/y-js/y-richtext/dist/y-richtext.js"></script>-->

    
    <script src="../../../bower_components/y-memory/y-memory.js"></script>
    <script src="../../../bower_components/y-map/y-map.js"></script>
    <script src="../../../bower_components/y-array/y-array.js"></script>
    <script src="../../../bower_components/y-text/y-text.js"></script>

    <script src="y-websockets-client.js"></script>

    <script src="../../../bower_components/jsplumb/dist/js/jsPlumb-2.1.0.js"></script>
    <script src="../../../bower_components/axios/dist/axios.min.js"></script>
    <script src="https://cdn.rawgit.com/cpettitt/dagre/master/dist/dagre.js"></script>

    <script src="https://rawgit.com/rwth-acis/SWeVA-Core/master/app/core.build.js"></script>
    <script src="../../../bower_components/download-as-file/dist/download-as-file.js"></script>
    <!--<script src="../../../bower_components/dagre/dist/dagre.core.min.js"></script>
    <!--<script src="../../../bower_components/graphlib/dist/graphlib.core.min.js"></script>-->
    <script>

        (function () {
            'use strict';

            Polymer({
                is: 'sweva-editor',
                properties: {
                    jsPlumbInstance: {
                        type: Object,
                        value: null
                    },

                    yjs: {
                        type: Object,
                        value: null
                    },
                    repositoryAddress: {
                        type: String,
                        value: 'http://localhost:5001/examplesJSON/'
                    },
                    repositorySuffix: {
                        type: String,
                        value: '.json'
                    },
                    project: {
                        type: Object,
                        value: {
                            code: '',
                            input: '',
                            data: ''
                        }
                    },
                    executionManager: {
                        type: Object,
                        value: null
                    },
                    canvasOffset: {
                        type: Object,
                        value: {
                            x: -2000,
                            y: -2000
                        }
                    },
                    room: {
                        type: String,
                        value: '',
                        observer: '_roomChanged'
                    }
                },
                _roomChanged: function(){
                    this.start(this.room)
                },
                handleNodeSelection: function (event) {

                    var panel = this.querySelector('sweva-panel');
                    panel.updateNode(event.detail);
                    var userManager = this.querySelector('sweva-user-manager');

                    userManager.updateSelectedNode(event.detail);
                },
                handleCanvasMouseMove: function (event) {

                    var position = event.detail;
                    var userManager = this.querySelector('sweva-user-manager');

                    userManager.updateCursor(position.x, position.y);
                },
                handleViewPortChanced: function (event) {
                    var cursors = this.querySelector('#cursor-awareness');
                    cursors.updateViewport(event.detail);

                    var nodeManager = this.querySelector('sweva-node-manager');
                    nodeManager.updateViewport(event.detail);

                },

                handleUserAdded: function (event) {
                    if (!event.detail.isSelf) {
                        var cursors = this.querySelector('#cursor-awareness');
                        cursors.add(event.detail);
                    }

                },
                handleUserDeleted: function (event) {
                    if (!event.detail.isSelf) {
                        var cursors = this.querySelector('#cursor-awareness');
                        cursors.remove(event.detail);
                        var nodeManager = this.querySelector('sweva-node-manager');
                        nodeManager.selectNodeBy('', '', '#fff');
                    }

                },
                handleUserUpdated: function (event) {
                    var cursors = this.querySelector('#cursor-awareness');
                    cursors.update(event.detail.id, event.detail);
                    if (!event.detail.isSelf && event.detail.selectedNode) {
                        var userManager = this.querySelector('sweva-user-manager');
                        var color = userManager.getUserColor(event.detail.id);
                        var nodeManager = this.querySelector('sweva-node-manager');
                        nodeManager.selectNodeBy(event.detail.selectedNode, event.detail.id, color);
                    }
                    if (event.detail.isSelf && (event.detail.name || event.detail.color)) {
                        var panel = this.querySelector('sweva-panel');
                        panel.updateUser(event.detail);

                        var chat = this.querySelector('sweva-chat');
                        chat.updateUser(event.detail);
                    }
                },
                handleUserDataChanged: function (event) {
                    var userManager = this.querySelector('sweva-user-manager');
                    userManager.update(userManager.ownId, event.detail);
                },
                handleClearAll: function (event) {
                    var nodeManager = this.querySelector('sweva-node-manager');
                    nodeManager.clear();
                },
                handleDownloadProject: function () {
                    var nodeManager = this.querySelector('sweva-node-manager');
                    var code = this.project.code;
                    if (code.trim().length == 0) {
                        code = sweva.ComposableLoader.getDefaultComposition();
                    }
                    var obj = nodeManager.getComposition(code);

                    var data = JSON.stringify(obj, null, 4);
                    downloadAsFile({
                        data: data,
                        filename: (obj.name || 'composition') + '.json'
                    })

                },
                handleAutoLayout: function (event) {
                    var nodeManager = this.querySelector('sweva-node-manager');
                    nodeManager.autoLayout();
                },
                handleCreateNode: function (event) {
                    var nodeManager = this.querySelector('sweva-node-manager');
                    nodeManager.createNode(event.detail);

                },
                handleDeleteNode: function (event) {
                    var nodeManager = this.querySelector('sweva-node-manager');
                    nodeManager.deleteNode(event.detail);
                },
                handleEditProject: function () {
                    var editor = this.querySelector('#editor-dialog');

                    if (editor) {
                        var code = this.project.code;
                        if (code.trim().length == 0) {
                            code = sweva.ComposableLoader.getDefaultComposition();
                        }
                        editor.open('Edit Project', 'project.code', code);
                    }
                },
                handleGenerateInputData: function () {
                    var nodeManager = this.querySelector('sweva-node-manager');
                    var obj = nodeManager.getDefaultInputData();

                    this.yjs.share.project.set('data', JSON.stringify(obj.data, null, 4));
                    this.yjs.share.project.set('input', JSON.stringify(obj.input, null, 4));
                },
                handleEditComplete: function (event) {
                    var id = event.detail.id;
                    var code = event.detail.code;
                    if (code) {
                        if (id == 'project.code') {
                            this.yjs.share.project.set('code', code);
                        }
                        else if (id == 'project.input') {
                            this.yjs.share.project.set('input', code);
                        }
                        else if (id == 'project.data') {
                            this.yjs.share.project.set('data', code);
                        }
                        else {
                            var node = document.getElementById(id);

                            if (node) {
                                node.updateCode(code);
                            }
                        }
                    }
                },
                handleEditNode: function (event) {
                    var node = event.detail;

                    if (node) {
                        var editor = this.querySelector('#editor-dialog');

                        if (editor) {
                            editor.open('Edit Node ' + node.alias, node.id, node.code);
                        }
                    }
                },
                handleExecute: function () {
                    var nodeManager = this.querySelector('sweva-node-manager');
                    var code = this.project.code;
                    if (code.trim().length == 0) {
                        code = sweva.ComposableLoader.getDefaultComposition();
                    }
                    var obj = nodeManager.getComposition(code);

                    var data = JSON.parse(sweva.ComposableLoader.convertCodeToJson(this.project.data));
                    var input = JSON.parse(sweva.ComposableLoader.convertCodeToJson(this.project.input));

                   
                   


                   
                    this.executionManager.setup(obj);
                    var panel = this.querySelector('sweva-panel');
                    panel.resetProgress();
                    this.executionManager.execute(
                    data,
                    input
                    )
                    .then(function (result) {
                        
                        console.log(result);

                    });
                },
                handleEditData: function () {
                    var editor = this.querySelector('#editor-dialog');
                    
                    if (editor) {
                        editor.open('Edit Execution Data', 'project.data', this.project.data);
                    }
                },
                handleEditInput: function () {
                    var editor = this.querySelector('#editor-dialog');

                    if (editor) {
                        editor.open('Edit Execution Input', 'project.input', this.project.input);
                    }
                },
                handleJsPlumbLoaded: function (event) {
                    var canvas = this.querySelector('sweva-canvas');
                    if (canvas) {
                        canvas.jsPlumbInstance = event.detail;
                    }
                },
                handleImported: function (event) {
                    var mode = event.detail.mode;
                    var content = event.detail.content;
                    var alias = event.detail.alias;

                    if (typeof content !== 'string' || content.trim().length < 1) {
                        return;
                    }

                    var nodeManager = this.querySelector('sweva-node-manager');

                    switch (mode) {
                        case 'importNodeJson':
                            nodeManager.importNodeJson(alias, content);
                            break;
                        case 'importNodeObject':
                            nodeManager.importNodeObject(alias, content);
                            break;
                        case 'importCompositionJSON':
                            nodeManager.importCompositionJSON(content);

                            var obj = JSON.parse(content);
                            if (obj.hasOwnProperty('composables')) {
                                delete obj.composables;
                            }
                            if (obj.hasOwnProperty('links')) {
                                delete obj.links;
                            }
                            var code = sweva.ComposableLoader.convertJsonToCode(obj);
                            this.yjs.share.project.set('code', code);
                            break;
                        case 'importCompositionObject':
                            nodeManager.importCompositionObject(content);
                            break;

                        default:

                    }
                },
                handleSwitchRoom: function(event){
                    var room = event.detail;
                    if (typeof room !== 'string'
                        || room.trim().length == 0
                        || room == this.room) {
                        return;
                    }
                    
                    this.cleanUp();
                    this.room = room;
                    //this.start(room);
                    
                },
                cleanUp: function () {
                    var cursorAwareness = this.querySelector('sweva-cursor-awareness');
                    cursorAwareness.cleanUp();
                    var userManager = this.querySelector('sweva-user-manager');
                    userManager.cleanUp();
                    var userChat = this.querySelector('sweva-chat');
                    userChat.cleanUp();
                    var nodeManager = this.querySelector('sweva-node-manager');
                    nodeManager.cleanUp();
                    this.yjs = null;
                },
                start: function (room) {
                    
                    if (typeof room !== 'string'
                        || room.trim().length == 0) {
                        return;
                    }
                    var self = this;
                    this.executionManager = new sweva.ExecutionManager();
                    this.executionManager.onProgress(function (progress) {
                        var panel = self.querySelector('sweva-panel');
                        panel.updateProgress(progress);
                    });
                    var panel = this.querySelector('sweva-panel');
                    panel.updateRoom(room);
                    Y({
                        db: {
                            name: 'memory'
                        },
                        connector: {
                            name: 'websockets-client',
                            room: room
                            // debug: true,
                            // url: 'http://127.0.0.1:2345'
                        },
                        sourceDir: /*'../../bower_components/',//*/'http://127.0.0.1:8021/yjs/bower_components',
                        share: {
                            //nodes: 'Map',
                            nodes: 'Map',
                            edges: 'Map',
                            users: 'Map',
                            chat: 'Array',
                            project: 'Map'
                        }
                    }).then(function (y) {
                        self.yjs = y;
                        var yjs = y;
                        console.log(y);
                        //yjs.share.text.bind(document.querySelector("#editor-dialog #editor"))
                        var userManager = self.querySelector('sweva-user-manager');
                        userManager.init(yjs);
                        var userChat = self.querySelector('sweva-chat');
                        userChat.init(yjs);
                        var nodeManager = self.querySelector('sweva-node-manager');
                        nodeManager.init(yjs);

                        yjs.share.project.observe(function (events) {
                            var code = yjs.share.project.get('code') || '';
                            var input = yjs.share.project.get('input') || {};
                            var data = yjs.share.project.get('data') || {};
                            self.project.code = code;
                            self.project.input = input;
                            self.project.data = data;
                        });

                        console.log('loaded');
                    });
                },
                ready: function () {
                    
                    
                    

                },
                attached: function () {                    
                    
                }

            });
        })();
    </script>
</dom-module>