<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../../bower_components/paper-color-picker/paper-color-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">



<link rel="import" href="sweva-import-export-dialog.html">

<dom-module id="sweva-panel">
    <template>
        <style>
            :host {
                display: flex;
                width: 300px;
                background-color: white;
                box-shadow: 0 2px 8px #555;
                position: relative;
                flex-direction: column;
            }
            iron-pages {
                flex: 1 1 0;
                overflow: auto;
            }
            #demo-controls{
                border-top: 1px solid #999;
                

            }
            #demo-controls paper-progress{
               width: 100%;

            }
            paper-tabs, paper-toolbar {
                background-color: #0094ff;
                color: #fff;
                box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
                --paper-tabs-selection-bar-color: #ff6a00;
            }

                paper-toolbar paper-tabs {
                    box-shadow: none;
                }

                paper-tabs[noink][no-bar] paper-tab.iron-selected {
                    color: #ff6a00;
                }

            .tab-page {
                padding: 5px;
                overflow: auto;
            }

            paper-button {
                background-color: #0094ff;
                color: #fff;
                margin: 5px;
                width: 100%;
            }

            paper-card {
                width: 100%;
                margin-bottom: 18px;
                --paper-card-header-text:
                {
                    padding: 8px;
                    text-align: center;
                }

                --paper-card-header: {
                    border-bottom: 1px solid #ccc;
                }

            }

            paper-textarea {
                display: block;
                width: 100%;
                max-height: 500px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            paper-dialog {
                background: #fff;
            }
            paper-icon-button.pink{
                color: #db0064;
            }
            #room-selector{
                display: flex;
                padding: 0 10px;
            }
            #room-selector paper-icon-button{
                margin-top: 10px;
            }
            #room-name{
                flex: 1 1 0;
            }
           
        </style>
        <div id="room-selector">
            <paper-input id="room-name" label="Room" value="{{room}}"></paper-input>
            <paper-icon-button title="Switch Room" icon="icons:launch" on-click="handleSwitchRoom"></paper-icon-button>
        </div>
        <paper-tabs selected="{{selectedTab}}" noink>
            <paper-tab>Create</paper-tab>
            <paper-tab>Edit</paper-tab>
            <paper-tab>Export</paper-tab>
            <paper-tab>Settings</paper-tab>
        </paper-tabs>

        <sweva-import-export-dialog id="import-export-dialog"
                                    on-accepted="handleImportExportDialogAccepted">
        </sweva-import-export-dialog>

        <iron-pages selected="{{selectedTab}}">
            <div class="tab-page">

                <paper-card heading="New Node">
                    <div class="card-content">
                        <paper-input id="create-node-name" label="Alias" value="{{createNodeAlias}}"></paper-input>
                        <paper-input id="create-node-url" label="Url" value="{{createNodeUrl}}"></paper-input>

                        <paper-button raised on-click="handleCreateNodeUrlFixed">Create From Url (read-only)</paper-button>
                        <paper-button raised on-click="handleCreateNode">Create Empty</paper-button>
                        <paper-button raised on-click="handleCreateNodeUrl">Create From Url</paper-button>

                        <paper-button raised on-click="handleImportNodeJSON">Import as JSON</paper-button>
                        <paper-button raised on-click="handleImportNodeObject">Import as Object</paper-button>
                    </div>
                </paper-card>

                <paper-card heading="Import Project">
                    <div class="card-content">
                        <paper-button raised on-click="handleImportCompositionJSON">Import as JSON</paper-button>
                       <!-- <paper-button raised on-click="handleImportCompositionObject">Import as Object</paper-button>-->
                    </div>
                </paper-card>

                <paper-card heading="Utilities">
                    <div class="card-content">
                        <paper-button raised on-click="handleClearAll">Clear All</paper-button>
                        <paper-button raised on-click="handleAutoLayout">Auto Layout</paper-button>
                    </div>
                </paper-card>
            </div>
            <div class="tab-page">
                <paper-card heading="Edit Node">
                    <div class="card-content">
                        <paper-input id="node-alias" label="Alias" on-blur="handlePotentialAliasUpdate" on-focus="handlePotentialAliasUpdate" value="{{selectedNode.alias}}"></paper-input>
                        <paper-textarea id="node-description" label="Description" readonly value="{{selectedNode.description}}"></paper-textarea>
                        <paper-button raised on-click="handleNodeEdit">Edit Code Collaboratively</paper-button>
                        <!--<paper-button raised on-click="handleNodeUpdate">Update</paper-button>-->
                    </div>
                </paper-card>
                <paper-card heading="Edit Project">
                    <div class="card-content">
                       
                        <paper-button raised on-click="handleProjectEdit">Edit Code Collaboratively</paper-button>
                        <!--<paper-button raised on-click="handleProjectUpdate">Update</paper-button>-->
                    </div>
                </paper-card>
                <paper-card heading="Delete Node">
                    <div class="card-content">
                        <paper-button raised on-click="handleNodeDelete">Delete</paper-button>
                    </div>
                </paper-card>
            </div>
            <div class="tab-page">

                <paper-card heading="Export Project">
                    <div class="card-content">
                        <paper-button raised on-click="handleDownloadComposition">Download Project</paper-button>
                        <paper-button raised on-click="handleSubmitComposition">Submit to Repository</paper-button>
                    </div>
                </paper-card>

                <paper-card heading="Export Node">
                    <div class="card-content">
                        <paper-button raised on-click="handleDownloadNode">Download Node</paper-button>
                        <paper-button raised on-click="handleSubmitNode">Submit to Repository</paper-button>
                    </div>
                </paper-card>
            </div>
            <div class="tab-page">
                <paper-card heading="User Settings">
                    <div class="card-content">
                        <paper-input id="user-name" label="Name" value="{{username}}"></paper-input>
                        <paper-color-input label="Color" value="{{usercolor}}"></paper-color-input>
                        <paper-button raised on-click="handleUserUpdateClick">Update</paper-button>
                    </div>
                </paper-card>
            </div>
        </iron-pages>
        <div id="demo-controls">
            <paper-progress value="{{progress}}"></paper-progress>
            <paper-icon-button title="Execute" icon="av:play-arrow" on-click="handleExecute"></paper-icon-button>
            <paper-icon-button title="Set Data For Execution" icon="icons:input" on-click="handleEditData"></paper-icon-button>
            <paper-icon-button title="Set Input For Execution" icon="icons:system-update-alt" on-click="handleEditInput"></paper-icon-button>
            <paper-icon-button title="Generate Input and Data  Templates" icon="av:playlist-add" on-click="handleGenerateInputData" class="pink"></paper-icon-button>
        </div>
    </template>
    
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'sweva-panel',
                properties: {
                    selectedTab: {
                        type: Number,
                        value: 0
                    },
                    createNodeAlias: {
                        type: String,
                        value: 'MyNode'
                    },
                    createNodeUrl: {
                        type: String,
                        value: ''
                    },
                    selectedNode: {
                        type: Object,
                        value: null
                    },
                    progress:{
                        type: Number,
                        value:0
                    },
                    username: {
                        type: String,
                        value: 'User',
                    },
                    room: {
                        type: String,
                        value: '',
                    },
                    usercolor: {
                        type: Object,
                        value: {
                            red: 0,
                            green: 150,
                            blue: 136
                        }
                    }

                },

                ready: function () {

                },
                attached: function () {

                },
                updateProgress: function(value){
                    this.progress = value;
                },
                resetProgress: function(){
                    this.progress = 0;
                },
                handleExecute: function(){
                    this.fire('execute', {});
                },
                handleEditData: function () {
                    this.fire('editdata', {});
                },
                handleEditInput: function () {
                    this.fire('editinput', {});
                },
                handleGenerateInputData: function(){
                    this.fire('generateinputdata', {});
                },
                handlePotentialAliasUpdate: function (event) {
                    var input = this.querySelector('#node-alias');
                    if (input && this.selectedNode) {
                        if (input.value != this.selectedNode.alias) {
                            input.value = this.selectedNode.alias;
                        }
                    }
                },
                handleSwitchRoom: function (){
                    this.fire('switchroom', this.room);
                },
                updateRoom: function (room) {
                    this.room = room;
                },
                handleAutoLayout: function () {
                    this.fire('autolayout', {});
                },
                handleImportExportDialogAccepted: function (event) {
                    if (event.detail.mode != 'export') {
                        this.fire('imported', { alias: this.createNodeAlias, mode: event.detail.mode, content: event.detail.content });
                    }
                },
                handleImportNodeJSON: function () {
                    var dialog = this.querySelector('#import-export-dialog');
                    if (dialog) {
                        dialog.openImport('importNodeJson', 'Import Node as JSON');
                    }
                },
                handleImportNodeObject: function () {
                    var dialog = this.querySelector('#import-export-dialog');
                    if (dialog) {
                        dialog.openImport('importNodeObject', 'Import Node as Object');
                    }
                },
                handleImportCompositionJSON: function () {
                    var dialog = this.querySelector('#import-export-dialog');
                    if (dialog) {
                        dialog.openImport('importCompositionJSON', 'Import Project as JSON');
                    }
                },
                handleImportCompositionObject: function () {
                    var dialog = this.querySelector('#import-export-dialog');
                    if (dialog) {
                        dialog.openImport('importCompositionObject', 'Import Project as Object');
                    }
                },
                handleNodeDelete: function () {
                    this.fire('deletenode', this.selectedNode);
                },
                handleClearAll: function () {
                    this.fire('clearall', {});
                },
                handleNodeEdit: function () {
                    this.fire('editnode', this.selectedNode);
                },
                handleNodeUpdate: function () {

                },
                handleProjectEdit: function () {
                    this.fire('editproject', this.selectedNode);
                },
                handleProjectUpdate: function () {

                },
                handleDownloadComposition: function () {
                    this.fire('downloadproject')
                },
                handleSubmitComposition: function () {

                },
                handleDownloadNode: function () {
                    if (this.selectedNode) {
                        downloadAsFile({
                            data: this.selectedNode.toJSON(),
                            filename: (this.selectedNode.name || 'node') + '.json'
                        });
                    }
                },
                handleSubmitNode: function () {

                },
                handleCreateNode: function () {
                    var alias = this.createNodeAlias;
                    if (alias.trim().length == 0) {
                        alias = 'Node';
                    }

                    this.fire('createnode', { alias: alias, url: '' });
                },
                handleCreateNodeUrl: function (event, a, fixed) {
                    var alias = this.createNodeAlias;
                    if (alias.trim().length == 0) {
                        alias = 'Node';
                    }
                    var url = this.createNodeUrl;

                    if (url.trim().length == 0) {
                        url = '';
                    }
                    var fix = false;
                    if (typeof fixed !== 'undefined' && fixed) {
                        fix = true;
                    }
                   
                    this.fire('createnode', { alias: alias, url: url, fixed: fix });
                },
                handleCreateNodeUrlFixed: function (event, a) {
                    this.handleCreateNodeUrl(event, a, true);
                },
                handleUserUpdateClick: function () {

                    console.log('userdataupdated')

                    function componentToHex(c) {
                        var hex = c.toString(16);
                        return hex.length == 1 ? "0" + hex : hex;
                    }

                    this.fire('userdatachanged', {
                        name: this.username,
                        color: "#" + ((1 << 24) + (this.usercolor.red << 16) + (this.usercolor.green << 8) + this.usercolor.blue).toString(16).slice(1)
                    })

                },
                updateNode: function (node) {

                    this.selectedNode = node;
                },
                updateUser: function (data) {

                    if (data.name) {
                        this.username = data.name;
                    }
                    if (data.color) {

                        function hexToRgb(hex) {
                            // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
                            var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
                            hex = hex.replace(shorthandRegex, function (m, r, g, b) {
                                return r + r + g + g + b + b;
                            });

                            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                            return result ? {
                                r: parseInt(result[1], 16),
                                g: parseInt(result[2], 16),
                                b: parseInt(result[3], 16)
                            } : null;
                        }
                        var color = hexToRgb(data.color);
                        var usercolor = {}
                        usercolor.red = color.r;
                        usercolor.green = color.g;
                        usercolor.blue = color.b;

                        this.querySelector('paper-color-input').value = usercolor;
                        this.querySelector('paper-color-input').ready();
                    }
                }

            });
        })();
    </script>
</dom-module>