<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="sweva-input-container.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<dom-module id="sweva-input-mapper">
	<template>
		<style>
			:host {
				width: 500px;
				height: 250px;
				display: flex;
				flex-direction: column;
				position: absolute;
				left: 2000px;
				top: 2000px;
				background-color: #ff6a00;
				border-radius: 10px;
				
			}

			#header {
				color: #fff;
				text-align: center;
				font-size: 15px;
				padding: 4px;
			}

			#content {
				padding: 25px 15px 20px 15px;
				flex: 1 1 0;
				display: flex;
				flex-direction: row;
			}

			#container {
				flex: 1 1 0;
				display: flex;
				flex-direction: row;
			}

			#content paper-icon-button {
				width: 70px;
				height: 70px;
				margin: 20px;
			}
		</style>
		<div id="header">
			Input Mapping
		</div>
		<div id="content">
			<div id="container">
			</div>
			<template is="dom-if" if="{{showAdd}}">
				<paper-icon-button title="Add"
								   icon="icons:add-circle-outline"
								   on-click="handleAdd">
				</paper-icon-button>
			</template>
		</div>
	</template>
	<script>
		(function () {
			'use strict';

			Polymer({
				is: 'sweva-input-mapper',
				properties: {
					posX: {
						type: Number,
						value: 50
					},
					posY: {
						type: Number,
						value: 50
					},
					yjs: {
						type: Object,
						value: null
					},
					jsPlumbInstance: {
						type: Object,
						value: null
					},
					containers: {
						type: Array,
						value: []
					},
					showAdd: {
						type: Boolean,
						value: false
					}
				},
				ready: function () {

				},
				attached: function () {

				},
				add: function (index) {


					var parent = this.$.container;
					var inputContainer = document.createElement('sweva-input-container');
					
					if (typeof index === 'number') {
					    var children = Polymer.dom(parent).childNodes;
					    if (index >= children.length) {
					        Polymer.dom(parent).appendChild(inputContainer);
					    }
					    else {
					        Polymer.dom(parent).insertBefore(inputContainer, children[index]);
					    }
					}
					else {
					    Polymer.dom(parent).appendChild(inputContainer);
					}

					inputContainer.init(this.jsPlumbInstance, this.yjs);
					inputContainer.addEventListener('moveleft', this.handleContainerMoveLeft.bind(this), false);
					inputContainer.addEventListener('moveright', this.handleContainerMoveRight.bind(this), false);
					inputContainer.addEventListener('close', this.handleContainerClose.bind(this), false);
					inputContainer.addEventListener('add', this.handleContainerAdd.bind(this), false);
					this.containers.push(inputContainer);
					this.updateWidth();

					if (this.showAdd) {
						this.showAdd = false;
					}

					
					
				},
				init: function (jsPlumb, yjs) {
					this.yjs = yjs;
					this.jsPlumbInstance = jsPlumb;

					this.add();
					this.add();
					this.add();
				},
				handleAdd: function () {
					this.add();
				},
				moveContainer: function (element, direction) {

					var parent = this.$.container;
					var children = Polymer.dom(parent).childNodes;
					var i = 0;
					var found = false;
					var child = null;
					for (i = 0; i < children.length; i++) {
						child = children[i];
						if (child.id == element.id) {
							found = true;
							break;
						}
					}
					if (direction == 'left') {

						if (found && i > 0) {
							Polymer.dom(parent).insertBefore(child, children[i - 1]);
						}
					}
					else {
						if (found && i < children.length - 1) {
							if (i < children.length - 2) {
								Polymer.dom(parent).insertBefore(child, children[i + 2]);
							}
							else {
								Polymer.dom(parent).removeChild(child);
								Polymer.dom(parent).appendChild(child);

							}

						}
					}
					Polymer.dom.flush();
					this.jsPlumbInstance.repaintEverything();
				},
				remove: function (element) {

					var parent = this.$.container;
					var i;
					var found = false;
					for (i = 0; i < this.containers.length; i++) {
						var container = this.containers[i];
						if (container.id == element.id) {
							Polymer.dom(parent).removeChild(element);
							found = true;
							break;
						}
					}
					if (found) {
						this.containers.splice(i, 1);
						if (this.containers.length == 0) {
							if (!this.showAdd) {
								this.showAdd = true;
							}
						}
					}
					this.updateWidth();
				},
				handleContainerMoveLeft: function (event) {
					this.moveContainer(event.detail, 'left');
				},
				handleContainerMoveRight: function (event) {
					this.moveContainer(event.detail, 'right');
				},
				handleContainerClose: function (event) {
					this.remove(event.detail);

				},
				handleContainerAdd: function (event) {
				    var element = event.detail;
				    

				    var parent = this.$.container;
				    var children = Polymer.dom(parent).childNodes;
				    var i = 0;
				    var found = false;
				    var child = null;
				    for (i = 0; i < children.length; i++) {
				        child = children[i];
				        if (child.id == element.id) {
				            found = true;
				            break;
				        }
				    }

				    if (found) {
				        this.add(i + 1);
				    }
				    
				},
				updateWidth: function () {
					var containerWidth = 50;
					if (this.containers.length > 0) {
						containerWidth = this.containers[0].width+10;
						this.style.width = (containerWidth * this.containers.length + 100) + 'px';
					}
					else {
						this.style.width = (containerWidth + 100) + 'px';
					}
					this.jsPlumbInstance.repaintEverything();
				},
				updatePos: function (x, y, fromYjs) {
					if (typeof x !== 'undefined' && typeof y !== 'undefined') {
						if (this.posX == x && this.posY == y) {
							return;
						}
						this.posX = x;
						this.posY = y;
					}

					this.style.left = this.posX + 'px';
					this.style.top = this.posY + 'px';

				}

			});
		})();
	</script>
</dom-module>